# 🚀 Проект: Автоматическое обновление Custom Geosite для OpenWrt

> **Дата создания:** 7 ноября 2024  
> **Статус:** Проектирование  
> **Версия:** 1.0

---

## 📋 Содержание

1. [Обзор проекта](#обзор-проекта)
2. [Проблема и решение](#проблема-и-решение)
3. [Цели и требования](#цели-и-требования)
4. [Архитектура системы](#архитектура-системы)
5. [Инфраструктура](#инфраструктура)
6. [Компоненты системы](#компоненты-системы)
7. [Workflow и процессы](#workflow-и-процессы)
8. [Технический стек](#технический-стек)
9. [Безопасность](#безопасность)
10. [Стоимость и экономика](#стоимость-и-экономика)
11. [План разработки](#план-разработки)
12. [Мониторинг и поддержка](#мониторинг-и-поддержка)

---

## 🎯 Обзор проекта

### Что это?

Система автоматического обновления кастомного `geosite.dat` файла для роутера Xiaomi AX3200 с OpenWrt и OpenClash, оптимизированная для минимального потребления оперативной памяти.

### Ключевые особенности

- ✅ **Автоматическая проверка** обновлений domain-list-community
- ✅ **Интерактивное управление** через Telegram бота с кнопками
- ✅ **Умная сборка** только нужных категорий geosite
- ✅ **Автоматическая публикация** в GitHub Releases
- ✅ **Автообновление роутера** с вашего GitHub
- ✅ **Экономия RAM** роутера: 70-80 МБ (вместо 100 МБ стандартного geosite)
- ✅ **Мониторинг роутера 24/7**: память, CPU, подключения, статус OpenClash
- ✅ **Умные алерты**: уведомления только при критических проблемах
- ✅ **Дашборд по кнопке**: полная статистика в Telegram без SSH
- ✅ **Централизованные логи**: хранение на Railway, не роутере

---

## 🔴 Проблема и решение

### Проблема

**Роутер Xiaomi AX3200:**
- Ограниченная RAM: 256 МБ
- Стандартный `geosite.dat`: ~25 МБ на диске → ~80-100 МБ в RAM
- OpenClash + geosite загружает все 400+ категорий, используется только 10-20
- Результат: нестабильная работа, зависания, нехватка памяти

### Решение

**Кастомный geosite.dat:**
- Включает ТОЛЬКО нужные категории (ads, google, youtube, etc.)
- Размер: ~3-5 МБ на диске → ~10-15 МБ в RAM
- **Экономия: 70-85 МБ RAM** (критично для AX3200!)
- Автоматическое обновление без ручного вмешательства

### Почему не альтернативы?

| Решение | Проблема |
|---------|----------|
| Стандартный geosite.dat | Слишком большой (~100 МБ RAM) |
| Sing-Box geodata | Экономит только 40%, все еще ~60 МБ RAM |
| Ручные правила | Нужно поддерживать вручную, быстро устаревает |
| **Кастомный geosite** | ✅ Решает все проблемы |

---

## 🎯 Цели и требования

### Бизнес-цели

1. **Стабильность роутера** - освободить 70-80 МБ RAM
2. **Актуальность данных** - регулярные обновления блокировочных списков
3. **Минимум ручной работы** - автоматизация 95% процессов
4. **Экономия денег** - использовать бесплатные/дешевые решения

### Функциональные требования

**Must Have (обязательно):**
- ✅ Автоматическая проверка обновлений domain-list-community
- ✅ Уведомления в Telegram о доступных обновлениях
- ✅ Возможность запустить сборку кнопкой из Telegram
- ✅ Автоматическая сборка кастомного geosite.dat
- ✅ Публикация в GitHub Releases
- ✅ Автообновление роутера с GitHub

**Should Have (желательно):**
- ✅ Анализ изменений (какие категории обновились)
- ✅ Статистика обновлений
- ✅ История версий
- ✅ Проверка статуса роутера

**Could Have (опционально):**
- 🔵 Автоматическая сборка по критерию (>100 изменений)
- 🔵 Мониторинг работы роутера
- 🔵 Rollback к предыдущей версии
- 🔵 A/B тестирование разных конфигураций

### Нефункциональные требования

**Производительность:**
- Проверка обновлений: <15 секунд
- Сборка geosite: <5 минут
- Уведомление в Telegram: <5 секунд
- Обновление роутера: <1 минуты

**Надежность:**
- Uptime системы: >99% (допустимо несколько часов downtime)
- Не должна влиять на работу роутера (легкие задачи)
- Graceful degradation при недоступности компонентов

**Безопасность:**
- Webhook endpoint защищен токеном
- GitHub token безопасно хранится
- Telegram bot token не утекает
- Приватные данные не логируются

**Стоимость:**
- Целевой бюджет: <$3/мес
- Максимальный бюджет: $5/мес
- Railway: pay-as-you-go модель

---

## 🏗️ Архитектура системы

### Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                    DOMAIN-LIST-COMMUNITY                        │
│                   (upstream источник данных)                    │
│              github.com/v2fly/domain-list-community             │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │ Проверка обновлений
                             │ (GitHub API)
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    РОУТЕР OPENWRT (AX3200)                      │
│                      (всегда включен 24/7)                      │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 1: Проверка обновлений                           ││
│  │                                                             ││
│  │ • Cron: каждый день в 03:00                                ││
│  │ • Shell скрипт: check_geosite_updates.sh (~40 строк)      ││
│  │ • Задачи:                                                   ││
│  │   - curl к GitHub API (проверка коммитов)                  ││
│  │   - Сравнение с последней версией                          ││
│  │   - Отправка webhook на Railway (если есть обновления)     ││
│  │                                                             ││
│  │ Нагрузка: 5-10 МБ RAM, 10 сек, раз в день                 ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 2: Применение обновлений                         ││
│  │                                                             ││
│  │ • OpenClash Auto Update                                     ││
│  │ • Cron: каждое воскресенье в 03:00                         ││
│  │ • URL: github.com/USERNAME/geosite/releases/latest/...     ││
│  │ • Задачи:                                                   ││
│  │   - Скачивание нового geosite.dat                          ││
│  │   - Замена старого файла                                   ││
│  │   - Перезапуск Clash                                        ││
│  │                                                             ││
│  │ Нагрузка: 20-30 МБ RAM, 1-2 мин, раз в неделю             ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 3: Мониторинг системы ⚡ НОВОЕ                   ││
│  │                                                             ││
│  │ • Shell скрипт: monitor_router.sh (~60 строк)              ││
│  │ • Cron: каждые 5 минут                                      ││
│  │                                                             ││
│  │ Собираемые метрики:                                        ││
│  │   📊 RAM: total, used, free, available (%)                 ││
│  │   ⚡ CPU: load average (1m, 5m, 15m)                       ││
│  │   📱 Подключения: WiFi clients count                       ││
│  │   🔌 OpenClash: status, uptime, memory usage               ││
│  │                                                             ││
│  │ Логика работы:                                             ││
│  │   • Сбор метрик (free, top, ps, wc)                       ││
│  │   • Проверка критических порогов                           ││
│  │   • Отправка данных на Railway (webhook)                   ││
│  │   • Если критично → немедленный алерт                      ││
│  │   • Если норма → только сохранение статистики              ││
│  │                                                             ││
│  │ Критические пороги (алерты):                               ││
│  │   🔴 RAM > 85% → Telegram уведомление                      ││
│  │   🔴 CPU load > 3.0 → Telegram уведомление                 ││
│  │   🔴 OpenClash down → Telegram уведомление                 ││
│  │   🔴 OpenClash memory > 1.5GB → Telegram уведомление       ││
│  │                                                             ││
│  │ Нагрузка: 2-5 МБ RAM, 1-2 сек, каждые 5 мин               ││
│  │ (минимальное воздействие на роутер!)                       ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              │ Webhooks (POST requests)
                              │ 
                              │ 1. Geosite update:
                              │    {commit, changes}
                              │ 
                              │ 2. Monitoring (каждые 5 мин):
                              │    {metrics: {...}, timestamp, alert: false}
                              │ 
                              │ 3. Critical alert (немедленно):
                              │    {type: "ram"|"cpu"|"openclash", 
                              │     value, threshold, alert: true}
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                       RAILWAY PLATFORM                          │
│                   (работает по требованию)                      │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 4: Telegram Bot + Orchestrator                   ││
│  │                                                             ││
│  │ • Python Flask приложение                                   ││
│  │ • Спит большую часть времени (экономия денег)              ││
│  │ • Просыпается только при webhook                           ││
│  │                                                             ││
│  │ Функции:                                                    ││
│  │ ├─ Webhook endpoints для роутера                           ││
│  │ │  • /webhook/geosite-update (обновления)                 ││
│  │ │  • /webhook/monitoring (метрики каждые 5 мин)           ││
│  │ │  • /webhook/alert (критические алерты)                  ││
│  │ ├─ Анализ изменений (опционально)                          ││
│  │ ├─ Отправка уведомлений в Telegram                         ││
│  │ ├─ Обработка нажатий кнопок                                ││
│  │ ├─ Команды geosite: /check, /build, /history              ││
│  │ ├─ Команды мониторинга: /dashboard, /monitor, /alerts     ││
│  │ ├─ Хранение истории метрик (последние 24 часа)            ││
│  │ └─ Логирование событий                                      ││
│  │                                                             ││
│  │ Нагрузка: 100-150 МБ RAM при работе                        ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 5: Модуль мониторинга ⚡ НОВОЕ                   ││
│  │                                                             ││
│  │ • Хранение метрик в памяти (последние 24 часа)             ││
│  │ • Генерация дашборда для Telegram                          ││
│  │ • Анализ трендов и аномалий                                ││
│  │                                                             ││
│  │ Хранимые данные:                                           ││
│  │   • Метрики: timestamp, ram_percent, cpu_load, clients,   ││
│  │              openclash_status, openclash_memory            ││
│  │   • История: ~288 записей (24ч * 12/час = 288)            ││
│  │   • Размер: ~50-100 КБ в памяти                           ││
│  │                                                             ││
│  │ Дашборд включает:                                          ││
│  │   📊 Текущие значения всех метрик                         ││
│  │   📈 Графики ASCII (последние 6 часов)                    ││
│  │   ⚠️ Активные предупреждения                              ││
│  │   📉 Тренды (↗️ растет, ↘️ падает, → стабильно)          ││
│  │   🕐 Uptime роутера и OpenClash                           ││
│  │   📱 Список подключенных устройств                        ││
│  │                                                             ││
│  │ Нагрузка: +20-30 МБ RAM для хранения истории              ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 6: Модуль сборки Geosite                         ││
│  │                                                             ││
│  │ • Запускается только при нажатии кнопки                    ││
│  │ • Работает в отдельном потоке                              ││
│  │                                                             ││
│  │ Процесс сборки:                                            ││
│  │ 1. Git clone domain-list-community (~150 МБ)               ││
│  │ 2. Подготовка конфига (какие категории)                   ││
│  │ 3. Запуск Go build (~2-3 минуты)                          ││
│  │ 4. Генерация geosite.dat (~3-5 МБ)                         ││
│  │ 5. Вычисление SHA256 checksum                              ││
│  │ 6. Cleanup временных файлов                                ││
│  │                                                             ││
│  │ Нагрузка: 400-500 МБ RAM пик, 3-5 минут                   ││
│  └────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐│
│  │ КОМПОНЕНТ 7: Публикация в GitHub                           ││
│  │                                                             ││
│  │ • GitHub API v3                                             ││
│  │ • Personal Access Token для авторизации                    ││
│  │                                                             ││
│  │ Процесс публикации:                                        ││
│  │ 1. Создание нового Release (тег: vYYYY.MM.DD.HH)          ││
│  │ 2. Upload geosite.dat как asset                            ││
│  │ 3. Upload SHA256SUMS.txt                                    ││
│  │ 4. Описание: список изменений                              ││
│  │                                                             ││
│  │ Нагрузка: минимальная, <10 секунд                          ││
│  └────────────────────────────────────────────────────────────┘│
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              │ GitHub API
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                      GITHUB RELEASES                            │
│                     (хранение артефактов)                       │
│                                                                  │
│  Структура:                                                     │
│  ├─ Releases:                                                   │
│  │  ├─ v2024.11.07.12 (latest)                                │
│  │  │  ├─ geosite.dat (3.2 МБ)                                │
│  │  │  └─ SHA256SUMS.txt                                       │
│  │  ├─ v2024.10.31.15                                          │
│  │  └─ v2024.10.15.09                                          │
│  │                                                             │
│  └─ URL для скачивания (всегда latest):                       │
│     github.com/USER/REPO/releases/latest/download/geosite.dat │
└─────────────────────────────────────────────────────────────────┘
```

### Поток данных

```
1. ПРОВЕРКА (ежедневно)
   Роутер → GitHub API → Роутер → Railway (webhook)

2. УВЕДОМЛЕНИЕ
   Railway → Telegram API → Пользователь

3. СБОРКА (по запросу)
   Пользователь (кнопка) → Railway → GitHub (clone) → Railway (build)

4. ПУБЛИКАЦИЯ
   Railway → GitHub API → GitHub Releases

5. ОБНОВЛЕНИЕ (еженедельно)
   Роутер → GitHub Releases (download) → Роутер (apply)
```

### Граф зависимостей

```
domain-list-community (upstream)
    ↓
Роутер (проверка) → Railway (бот) → Пользователь (решение)
                                           ↓
                              Railway (сборка) → GitHub Releases
                                                       ↓
                                            Роутер (применение)
```

---

## 🏢 Инфраструктура

### Компонент 1: Роутер OpenWrt (Локальный)

**Характеристики:**
- **Модель:** Xiaomi AX3200
- **CPU:** MediaTek MT7622B (ARM Cortex-A53 Dual-Core 1.35GHz)
- **RAM:** 256 МБ DDR3
- **Storage:** 128 МБ NAND Flash
- **OS:** OpenWrt 23.05+
- **Uptime:** 24/7

**Роль в системе:**
- Lightweight проверка обновлений (cron)
- Применение обновлений (OpenClash)
- Основная функция: маршрутизация (не перегружать!)

**Ограничения:**
- ❌ НЕ может собирать geosite (мало RAM)
- ❌ НЕ может запускать тяжелые процессы
- ✅ Может делать HTTP запросы
- ✅ Может запускать легкие shell скрипты

**Доступ:**
- SSH: 192.168.31.1:22 (локальная сеть)
- Web UI: http://192.168.31.1
- OpenClash UI: http://192.168.31.1/cgi-bin/luci/admin/services/openclash

---

### Компонент 2: Railway (Cloud Platform)

**Характеристики:**
- **Тип:** PaaS (Platform as a Service)
- **Регион:** EU (Europa) для минимального latency
- **Pricing:** Pay-as-you-go
- **Ресурсы:**
  - RAM: до 8 GB (shared)
  - CPU: до 8 vCPU (shared)
  - Storage: 100 GB (ephemeral)
  - Network: неограниченно

**Роль в системе:**
- Telegram бот (легкая нагрузка)
- Сборка geosite.dat (тяжелая нагрузка, редко)
- Публикация в GitHub

**Режим работы:**
- **Спящий режим:** 99% времени (минимальные расходы)
- **Активный режим:** при получении webhook (~10 мин, 4-5 раз/мес)

**Доступ:**
- Dashboard: https://railway.app/dashboard
- CLI: `railway` command
- Logs: Real-time в веб-интерфейсе

**Стоимость (оценка):**
```
Проверок от роутера: 30/мес
Обновлений найдено: 4/мес
Сборок запущено: 4/мес

Время работы: 40 минут/мес
RAM usage: 500 МБ * 40 мин = 333 МБ*час
CPU usage: 1 vCPU * 40 мин = 0.67 vCPU*час

Стоимость: ~$0.50-2/мес
```

---

### Компонент 3: GitHub (Repository + Releases)

**Характеристики:**
- **Тип:** Git repository + CDN для releases
- **Visibility:** Public (или Private с токеном)
- **Storage:** Unlimited для releases
- **Bandwidth:** Unlimited для скачивания

**Роль в системе:**
- Хранение geosite.dat файлов
- Versioning (история изменений)
- CDN для скачивания роутером

**Структура репозитория:**
```
custom-geosite/
├── .github/
│   └── workflows/
│       └── manual-build.yml (опционально)
├── config/
│   └── categories.txt (список нужных категорий)
├── scripts/
│   └── build.sh (скрипт сборки, используется Railway)
├── README.md
└── CHANGELOG.md
```

**Releases:**
- Тег формат: `vYYYY.MM.DD.HH` (пример: v2024.11.07.15)
- Assets: geosite.dat, SHA256SUMS.txt
- Description: список изменений
- Latest release: всегда доступен по статичному URL

**Доступ:**
- Personal Access Token (для Railway)
- Scope: `repo` (полный доступ к репозиторию)

---

### Компонент 4: Telegram Bot API

**Характеристики:**
- **API:** Telegram Bot API v6.0+
- **Rate Limits:** 30 сообщений/секунду
- **Методы:** sendMessage, editMessageText, answerCallbackQuery

**Роль в системе:**
- Уведомления пользователя
- Интерактивные кнопки
- Команды управления

**Интеграция:**
- Long polling (не webhook, проще для Railway)
- Библиотека: python-telegram-bot v20+

---

## 🔧 Компоненты системы

### 1. Роутер: Скрипт проверки обновлений

**Файл:** `/root/check_geosite_updates.sh`

**Размер:** ~40 строк shell script

**Функционал:**
1. Запрос к GitHub API (последний коммит)
2. Чтение сохраненного коммита из файла
3. Сравнение версий
4. Если есть обновление:
   - Отправка webhook на Railway
   - Сохранение новой версии
5. Логирование результата

**Зависимости:**
- `curl` (есть в OpenWrt)
- `grep`, `cut` (есть в OpenWrt)

**Cron:**
```bash
0 3 * * * /root/check_geosite_updates.sh >> /tmp/geosite_check.log 2>&1
```

**Конфигурация:**
- GitHub repo: переменная в скрипте
- Railway webhook URL: переменная в скрипте
- Secret token: переменная в скрипте
- State file: `/tmp/geosite_last_commit.txt`

---

### 2. Railway: Telegram Bot + Orchestrator

**Файл:** `app.py` + вспомогательные модули

**Размер:** ~300-400 строк Python

**Структура:**
```
railway-geosite-bot/
├── app.py              # Главный файл (Flask + Telegram bot)
├── builder.py          # Модуль сборки geosite
├── github_api.py       # Работа с GitHub API
├── config.py           # Конфигурация
├── requirements.txt    # Зависимости Python
├── Procfile           # Команда запуска для Railway
└── runtime.txt        # Версия Python
```

**Модули:**

**app.py - Главное приложение:**
- Flask web server (webhook endpoint)
- Telegram bot (python-telegram-bot)
- Маршрутизация запросов
- Обработка команд и кнопок

**builder.py - Сборка geosite:**
- Клонирование domain-list-community
- Чтение конфигурации категорий
- Запуск Go build
- Генерация geosite.dat
- Вычисление checksum
- Cleanup

**github_api.py - GitHub интеграция:**
- Создание Release
- Upload файлов
- Получение информации о коммитах
- Анализ изменений (diff)

**config.py - Настройки:**
- Telegram bot token
- Telegram chat ID
- GitHub token
- GitHub repo
- Railway webhook secret
- Категории для сборки

**Endpoints:**
```
# Geosite webhooks
POST /webhook/geosite-update    # Обновления от роутера

# Monitoring webhooks ⚡ НОВЫЕ
POST /webhook/monitoring         # Метрики (каждые 5 мин)
POST /webhook/alert              # Критические алерты

# System endpoints
GET /health                      # Health check
GET /status                      # Статус системы
GET /metrics/latest              # Последние метрики (API)
```

**Команды бота (Geosite):**
```
/start       - Приветствие и инструкция
/status      - Текущий статус geosite
/check       - Проверить обновления сейчас
/build       - Принудительная сборка
/history     - История последних обновлений
/help        - Помощь
```

**Команды бота (Мониторинг) ⚡ НОВЫЕ:**
```
/dashboard   - 📊 Полный дашборд роутера
/monitor     - 📈 Быстрый обзор метрик
/alerts      - ⚠️ История алертов (последние 24ч)
```

**Интерактивные кнопки (Geosite):**
```
🔄 Собрать и опубликовать
📋 Показать детали изменений
⏭️ Пропустить это обновление
⏰ Напомнить через 3 дня
```

**Интерактивные кнопки (Мониторинг) ⚡ НОВЫЕ:**
```
📊 Dashboard     - Показать дашборд
🔄 Refresh       - Обновить метрики
📈 Graphs        - Графики за 6ч/24ч
⚠️ Alerts        - История алертов
📋 Details       - Детальная информация
```

---

### 3. Railway: Модуль сборки

**Процесс сборки (подробно):**

**Шаг 1: Подготовка окружения**
```python
# Создание временной директории
temp_dir = tempfile.mkdtemp()
os.chdir(temp_dir)

# Установка Go (если нужно)
# На Railway можно использовать nixpacks для автоматической установки
```

**Шаг 2: Клонирование репозитория**
```bash
git clone --depth=1 https://github.com/v2fly/domain-list-community.git
cd domain-list-community
```

**Шаг 3: Конфигурация сборки**
```python
# Чтение списка категорий из config
categories = [
    "category-ads-all",
    "google",
    "youtube",
    "apple",
    "netflix",
    # ... другие нужные категории
]

# Создание конфигурационного файла для сборщика
# (указываем какие категории включить)
```

**Шаг 4: Сборка**
```bash
go run ./main.go \
  --datapath=./data \
  --outputname=geosite.dat \
  --outputdir=./output \
  --include="category-ads-all,google,youtube,..."
```

**Шаг 5: Проверка и checksum**
```bash
# Проверка что файл создан и не пустой
ls -lh output/geosite.dat

# Вычисление SHA256
sha256sum output/geosite.dat > output/SHA256SUMS.txt
```

**Шаг 6: Публикация**
```python
# Через GitHub API
github_api.create_release(
    tag=f"v{datetime.now().strftime('%Y.%m.%d.%H')}",
    name=f"Geosite {datetime.now().strftime('%Y-%m-%d')}",
    body=changelog,
    files=["geosite.dat", "SHA256SUMS.txt"]
)
```

**Шаг 7: Cleanup**
```python
os.chdir("/")
shutil.rmtree(temp_dir)
```

**Обработка ошибок:**
- Таймаут сборки (>10 минут)
- Ошибки Git
- Ошибки компиляции Go
- Ошибки публикации GitHub
- Уведомление пользователя при ошибках

---

### 4. GitHub: Хранилище релизов

**Структура Release:**
```yaml
Tag: v2024.11.07.15
Name: "Geosite Update 2024-11-07"
Description: |
  Custom geosite.dat build
  
  Changes since last version:
  - category-ads-all: +156 domains
  - google: +12 domains
  - youtube: +5 domains
  
  Total size: 3.4 MB
  Categories included: 8
  
  Based on domain-list-community commit: abc123def

Assets:
  - geosite.dat (3.4 MB)
  - SHA256SUMS.txt (65 bytes)
```

**URL для скачивания:**
```
# Latest (всегда актуальный)
https://github.com/USERNAME/custom-geosite/releases/latest/download/geosite.dat

# Specific version
https://github.com/USERNAME/custom-geosite/releases/download/v2024.11.07.15/geosite.dat
```

---

### 5. OpenClash: Конфигурация автообновления

**Настройка в OpenClash UI:**

**Путь:** Plugin Settings → Overwrite Settings → GeoIP Update Settings

**Параметры:**
```yaml
GeoSite Database Update: Enabled
GeoSite Database URL: https://github.com/USERNAME/custom-geosite/releases/latest/download/geosite.dat
Auto Update: Enabled
Update Schedule: Weekly
Update Day: Sunday
Update Time: 03:00
Verify Checksum: Enabled (опционально)
```

**Процесс обновления OpenClash:**
1. В указанное время запускается задача
2. Скачивается файл по URL
3. Проверяется размер (должен быть >100 КБ)
4. Опционально: проверка checksum
5. Замена старого файла новым
6. Перезапуск Clash ядра
7. Проверка что все работает

---

## 🔄 Workflow и процессы

### Процесс 1: Ежедневная проверка обновлений

**Триггер:** Cron на роутере, каждый день в 03:00

**Участники:**
- Роутер (инициатор)
- GitHub API (источник данных)
- Railway (обработчик)

**Шаги:**

```
1. [03:00] Роутер: Cron запускает скрипт
   └─> check_geosite_updates.sh

2. [03:00:01] Роутер: Запрос к GitHub API
   └─> GET https://api.github.com/repos/v2fly/domain-list-community/commits/master
   └─> Response: { "sha": "abc123...", "commit": {...} }

3. [03:00:03] Роутер: Чтение сохраненной версии
   └─> cat /tmp/geosite_last_commit.txt
   └─> Content: "xyz789..."

4. [03:00:04] Роутер: Сравнение
   └─> if "abc123" != "xyz789" then UPDATE_AVAILABLE

5a. [03:00:05] Если НЕТ обновлений:
   └─> Логирование "No updates"
   └─> Выход

5b. [03:00:05] Если ЕСТЬ обновления:
   └─> Отправка webhook на Railway
   └─> POST https://geosite-bot.railway.app/webhook/geosite-update
   └─> Payload: {
         "commit": "abc123",
         "old_commit": "xyz789",
         "timestamp": "2024-11-07T03:00:05Z"
       }
   └─> Сохранение новой версии: echo "abc123" > /tmp/geosite_last_commit.txt

6. [03:00:06] Railway: Получение webhook
   └─> Валидация secret token
   └─> Извлечение данных

7. [03:00:07] Railway: Анализ изменений (опционально)
   └─> GET https://api.github.com/repos/.../compare/xyz789...abc123
   └─> Парсинг измененных файлов
   └─> Фильтрация по нужным категориям

8. [03:00:10] Railway: Формирование уведомления
   └─> Приоритет: HIGH/MEDIUM/LOW (по количеству изменений)
   └─> Текст с деталями

9. [03:00:11] Railway: Отправка в Telegram
   └─> Bot.send_message(
         chat_id=USER_CHAT_ID,
         text="🔔 Обновление geosite...",
         reply_markup=InlineKeyboard([...])
       )

10. [03:00:12] Пользователь: Получение уведомления
   └─> Видит кнопки: [🔄 Собрать] [⏭️ Пропустить]

11. Ожидание действия пользователя...
```

**Время выполнения:** 10-15 секунд

**Частота:** 1 раз в день

**Результат:** Уведомление пользователя о доступных обновлениях

---

### Процесс 2: Сборка и публикация (по запросу)

**Триггер:** Нажатие кнопки "🔄 Собрать" в Telegram

**Участники:**
- Пользователь (инициатор)
- Telegram Bot (интерфейс)
- Railway (исполнитель)
- GitHub (хранилище)

**Шаги:**

```
1. [12:30] Пользователь: Нажимает кнопку "🔄 Собрать"
   └─> Telegram отправляет callback query

2. [12:30:01] Railway: Получает callback
   └─> Callback data: "build:abc123"
   └─> Извлекает commit hash

3. [12:30:02] Railway: Мгновенный ответ
   └─> Bot.answer_callback_query("⏳ Начинаю сборку...")
   └─> Bot.edit_message("⏳ Сборка запущена...")

4. [12:30:03] Railway: Запуск сборки в отдельном потоке
   └─> Thread(target=build_geosite, args=(commit,)).start()

5. [12:30:05] Railway/Builder: Создание temp директории
   └─> temp_dir = /tmp/geosite_build_abc123/

6. [12:30:06] Railway/Builder: Клонирование репозитория
   └─> git clone --depth=1 https://github.com/v2fly/domain-list-community.git
   └─> Progress: 0% → 50% → 100%
   └─> Время: ~30 секунд

7. [12:30:36] Railway/Builder: Подготовка конфига
   └─> Чтение списка категорий из config.py
   └─> categories = ["category-ads-all", "google", ...]

8. [12:30:37] Railway/Builder: Запуск Go build
   └─> go run ./main.go --include="category-ads-all,google,..."
   └─> Progress: компиляция → парсинг → генерация
   └─> Время: ~2-3 минуты

9. [12:33:00] Railway/Builder: Проверка результата
   └─> ls -lh output/geosite.dat
   └─> -rw-r--r-- 1 root root 3.4M Nov  7 12:33 geosite.dat

10. [12:33:01] Railway/Builder: Вычисление checksum
   └─> sha256sum output/geosite.dat > SHA256SUMS.txt

11. [12:33:02] Railway/Builder: Уведомление прогресса
   └─> Bot.edit_message("✅ Сборка завершена! Публикация в GitHub...")

12. [12:33:05] Railway/GitHub: Создание Release
   └─> tag = "v2024.11.07.12"
   └─> name = "Geosite Update 2024-11-07"
   └─> body = changelog (детали изменений)
   └─> POST https://api.github.com/repos/.../releases

13. [12:33:06] Railway/GitHub: Upload assets
   └─> POST https://uploads.github.com/repos/.../releases/.../assets
   └─> Upload: geosite.dat (3.4 MB)
   └─> Upload: SHA256SUMS.txt (65 bytes)
   └─> Время: ~5-10 секунд

14. [12:33:15] Railway/Builder: Cleanup
   └─> rm -rf /tmp/geosite_build_abc123/

15. [12:33:16] Railway: Финальное уведомление
   └─> Bot.send_message(
         "✅ Готово!\n\n"
         "📦 Файл опубликован: v2024.11.07.12\n"
         "💾 Размер: 3.4 MB\n"
         "🔗 URL: github.com/.../releases/latest\n\n"
         "ℹ️ Роутер обновится автоматически в воскресенье 03:00"
       )

16. [12:33:17] Пользователь: Получает подтверждение
   └─> Видит что все готово
```

**Время выполнения:** 3-5 минут

**Частота:** 2-4 раза в месяц (по требованию)

**Результат:** Новый geosite.dat опубликован в GitHub Releases

---

### Процесс 3: Автообновление роутера

**Триггер:** Cron в OpenClash, каждое воскресенье в 03:00

**Участники:**
- OpenClash (инициатор)
- GitHub Releases (источник файла)
- Clash (применение)

**Шаги:**

```
1. [Воскресенье 03:00] OpenClash: Cron триггер
   └─> Задача: Update GeoSite Database

2. [03:00:01] OpenClash: Проверка URL
   └─> URL: https://github.com/USERNAME/custom-geosite/releases/latest/download/geosite.dat

3. [03:00:02] OpenClash: Скачивание файла
   └─> wget -O /tmp/geosite.dat.new "$URL"
   └─> Progress: 0% → 25% → 50% → 75% → 100%
   └─> Время: ~10-30 секунд (в зависимости от скорости сети)

4. [03:00:30] OpenClash: Проверка файла
   └─> Размер: stat -f%z /tmp/geosite.dat.new
   └─> Должен быть > 100 KB
   └─> Текущий: 3.4 MB ✓

5. [03:00:31] OpenClash: Backup старого файла
   └─> cp /etc/openclash/geosite.dat /etc/openclash/geosite.dat.backup

6. [03:00:32] OpenClash: Замена файла
   └─> mv /tmp/geosite.dat.new /etc/openclash/geosite.dat

7. [03:00:33] OpenClash: Перезапуск Clash
   └─> /etc/init.d/openclash restart
   └─> Время: ~5-10 секунд

8. [03:00:45] OpenClash: Проверка статуса
   └─> Clash работает? ✓
   └─> Правила загружены? ✓
   └─> Трафик проходит? ✓

9. [03:00:50] OpenClash: Логирование
   └─> echo "[2024-11-07 03:00:50] GeoSite updated successfully" >> /tmp/openclash.log

10. [03:00:51] Завершение
   └─> Роутер работает с новым geosite.dat
```

**Время выполнения:** 1-2 минуты

**Частота:** 1 раз в неделю

**Результат:** Роутер использует актуальный geosite.dat

---

### Процесс 4: Команды управления

**Команда: /status**

```
Пользователь → Telegram → Railway Bot

Bot отвечает:
┌────────────────────────────────────┐
│ 📊 Статус Geosite                  │
│                                    │
│ 🗓️ Текущая версия:                │
│    v2024.11.07.12                  │
│    Собрана: 7 ноября 2024, 12:33   │
│                                    │
│ 📦 Размер: 3.4 MB                  │
│ 📚 Категорий: 8                    │
│                                    │
│ ✅ Роутер: обновлен                │
│    Последнее обновление:           │
│    10 ноября 2024, 03:00           │
│                                    │
│ 🔍 Последняя проверка:             │
│    Сегодня в 03:00                 │
│    Новых обновлений нет            │
│                                    │
│ [🔄 Проверить сейчас]              │
└────────────────────────────────────┘
```

**Команда: /check**

```
Пользователь → Telegram → Railway Bot

Bot:
1. ⏳ "Проверяю обновления..."
2. Запрос к GitHub API
3. Сравнение с текущей версией
4. Ответ:
   
   Вариант A (нет обновлений):
   ✅ "Обновлений нет. Все актуально."
   
   Вариант B (есть обновления):
   🔔 "Найдены обновления!"
   [детали изменений]
   [🔄 Собрать] [⏭️ Пропустить]
```

**Команда: /history**

```
Показывает последние 5 обновлений:

┌────────────────────────────────────┐
│ 📜 История обновлений              │
│                                    │
│ 1. v2024.11.07.12                  │
│    • 7 ноября 12:33                │
│    • Изменения: ads +156, ...      │
│                                    │
│ 2. v2024.10.31.15                  │
│    • 31 октября 15:20              │
│    • Изменения: ads +89, ...       │
│                                    │
│ 3. v2024.10.15.09                  │
│    • 15 октября 09:45              │
│    • Изменения: google +15, ...    │
│                                    │
│ [Показать все] [Статистика]        │
└────────────────────────────────────┘
```

**Команда: /dashboard ⚡ НОВАЯ**

```
Пользователь → Telegram → Railway Bot

Bot отвечает полным дашбордом:
┌────────────────────────────────────┐
│ 📊 ROUTER DASHBOARD                │
│ Роутер: Xiaomi AX3200              │
│ Обновлено: только что              │
└────────────────────────────────────┘

💾 ПАМЯТЬ:
├─ Всего: 245 МБ
├─ Занято: 126 МБ (51%) ✅
├─ Свободно: 77 МБ
└─ Тренд: → стабильно

⚡ CPU:
├─ Load 1m:  0.45 ✅
├─ Load 5m:  0.52 ✅
├─ Load 15m: 0.38 ✅
└─ Тренд: ↘️ снижается

📱 ПОДКЛЮЧЕНИЯ:
├─ WiFi клиентов: 8
├─ Активных: 8
└─ Список: 
   • 192.168.31.112 (iPhone-Ivan-2)
   • 192.168.31.142 (Mac)
   • 192.168.31.102 (Yandex-Station)
   • [+5 еще...]

🔌 OPENCLASH:
├─ Статус: ✅ Running
├─ Uptime: 4 часа 23 минуты
├─ Memory: 1234 МБ (51%)
├─ Правил загружено: 15,234
└─ Последняя ошибка: нет

📈 ГРАФИК RAM (6 часов):
60% ┤         ╭───╮
55% ┤       ╭─╯   ╰─╮
50% ┤     ╭─╯       ╰╮
45% ┤   ╭─╯          ╰───
40% ┤───╯
    └─────────────────────────
    12:00  15:00  18:00  сейчас

⚠️ АЛЕРТЫ: Нет активных

🕐 Uptime: 18 часов 45 минут

[🔄 Обновить] [📈 Графики] [⚙️ Детали]
```

**Команда: /monitor ⚡ НОВАЯ (быстрый обзор)**

```
📊 Quick Status

💾 RAM: 51% ✅ | ⚡ CPU: 0.45 ✅
📱 Clients: 8 | 🔌 OpenClash: ✅

Все в норме 👍
[📊 Full Dashboard]
```

**Команда: /alerts ⚡ НОВАЯ**

```
⚠️ История алертов (24 часа)

┌────────────────────────────────────┐
│ 🔴 14:23 - RAM критично!           │
│    Занято: 223 МБ (91%)            │
│    Порог: 85%                      │
│    Длительность: 3 минуты          │
│    Решено: автоматически           │
└────────────────────────────────────┘

┌────────────────────────────────────┐
│ 🟡 08:15 - CPU высокая нагрузка    │
│    Load: 3.2                       │
│    Порог: 3.0                      │
│    Длительность: 2 минуты          │
│    Решено: автоматически           │
└────────────────────────────────────┘

Всего за 24ч: 2 алерта
Критичных: 1 | Предупреждений: 1

[📊 Dashboard] [📈 Графики]
```

---

### Процесс 5: Мониторинг роутера ⚡ НОВЫЙ

**Триггер:** Cron на роутере, каждые 5 минут

**Участники:**
- Роутер (сбор метрик)
- Railway (хранение и анализ)
- Telegram (алерты при проблемах)

**Шаги (нормальный сценарий):**

```
1. [XX:00] Роутер: Cron запускает скрипт
   └─> monitor_router.sh

2. [XX:00:01] Роутер: Сбор метрик RAM
   └─> free -m | awk '{print $2,$3,$4}'
   └─> Total: 245, Used: 126, Free: 77
   └─> Процент: 51%

3. [XX:00:02] Роутер: Сбор метрик CPU
   └─> cat /proc/loadavg | awk '{print $1,$2,$3}'
   └─> 0.45 0.52 0.38

4. [XX:00:03] Роутер: Подсчет подключений
   └─> iw dev wlan0 station dump | grep Station | wc -l
   └─> 8 клиентов

5. [XX:00:04] Роутер: Статус OpenClash
   └─> /etc/init.d/openclash status
   └─> running
   └─> ps | grep clash | awk '{print $6}'
   └─> 1234m

6. [XX:00:05] Роутер: Проверка порогов
   └─> RAM 51% < 85% ✓
   └─> CPU 0.45 < 3.0 ✓
   └─> OpenClash running ✓
   └─> Результат: ВСЕ НОРМА

7. [XX:00:06] Роутер: Отправка на Railway
   └─> POST https://geosite-bot.railway.app/webhook/monitoring
   └─> Payload: {
         "timestamp": "2024-11-07T15:00:06Z",
         "ram": {"total": 245, "used": 126, "percent": 51},
         "cpu": {"load1": 0.45, "load5": 0.52, "load15": 0.38},
         "clients": 8,
         "openclash": {"status": "running", "memory": 1234},
         "alert": false
       }

8. [XX:00:07] Railway: Получение данных
   └─> Сохранение в памяти (история 24ч)
   └─> Алерт не требуется

9. [XX:00:08] Завершение
   └─> Ждать следующего запуска через 5 минут
```

**Шаги (критический сценарий - RAM >85%):**

```
1-5. [Аналогично нормальному сценарию]

6. [XX:00:05] Роутер: Проверка порогов
   └─> RAM 89% > 85% ❌ КРИТИЧНО!
   └─> CPU 0.45 < 3.0 ✓
   └─> OpenClash running ✓
   └─> Результат: ALERT!

7. [XX:00:06] Роутер: Отправка ALERT на Railway
   └─> POST https://geosite-bot.railway.app/webhook/alert
   └─> Payload: {
         "type": "ram",
         "value": 89,
         "threshold": 85,
         "timestamp": "2024-11-07T15:00:06Z",
         "metrics": {...}
       }

8. [XX:00:07] Railway: Получение алерта
   └─> Анализ серьезности
   └─> Проверка истории (первый раз или повтор?)

9. [XX:00:08] Railway: Отправка в Telegram
   └─> Bot.send_message(
         "🔴 КРИТИЧНО: Память роутера!\n\n"
         "💾 Занято: 218 МБ (89%)\n"
         "⚠️ Порог: 85%\n"
         "📊 Свободно: 27 МБ\n\n"
         "🔌 OpenClash: 1234 МБ\n"
         "📋 Топ процессы:\n"
         "  • clash: 1234 МБ\n"
         "  • dnsmasq: 5 МБ\n\n"
         "⏰ Рекомендация: перезапустить OpenClash\n\n"
         "[📊 Dashboard] [🔄 Restart OpenClash]"
       )

10. [XX:00:09] Пользователь: Получает уведомление
    └─> Может нажать кнопку для действия

11. [XX:00:10] Завершение
    └─> Мониторинг продолжается каждые 5 минут
```

**Время выполнения:** 1-2 секунды (минимально!)

**Частота:** Каждые 5 минут (288 раз в день)

**Результат:** 
- Метрики хранятся на Railway (не на роутере)
- Алерты только при критических проблемах
- Дашборд доступен по кнопке

---

## 💻 Технический стек

### Языки программирования

**Shell Script (Bash)**
- Версия: sh (POSIX compatible)
- Использование: скрипт на роутере
- Почему: нативно доступен в OpenWrt, легковесный

**Python**
- Версия: 3.11+
- Использование: Railway приложение (бот + сборка)
- Почему: богатая экосистема, легко работать с API

**Go**
- Версия: 1.21+
- Использование: сборка geosite.dat (upstream tool)
- Почему: официальный инструмент от domain-list-community

---

### Библиотеки и фреймворки

**Python:**
```txt
# Web framework
flask==3.0.0

# Telegram bot
python-telegram-bot==20.7

# HTTP requests
requests==2.31.0

# GitHub API
PyGithub==2.1.1

# Async support
aiohttp==3.9.0

# Configuration
python-dotenv==1.0.0

# Logging
structlog==23.2.0

# Testing (опционально)
pytest==7.4.3
```

**JavaScript/Node.js (опционально, для расширений):**
```json
{
  "dependencies": {
    "telegraf": "^4.14.0",
    "octokit": "^3.1.0"
  }
}
```

---

### API и сервисы

**GitHub API v3**
- REST API
- Endpoints:
  - `/repos/{owner}/{repo}/commits` - получение коммитов
  - `/repos/{owner}/{repo}/compare/{base}...{head}` - сравнение
  - `/repos/{owner}/{repo}/releases` - работа с releases
- Rate limit: 5000 requests/hour (authenticated)

**Telegram Bot API**
- Версия: Bot API 6.0+
- Методы:
  - `sendMessage` - отправка сообщений
  - `editMessageText` - редактирование сообщений
  - `answerCallbackQuery` - ответ на кнопки
  - `getUpdates` - получение обновлений (long polling)
- Rate limit: 30 messages/second

---

### Инструменты разработки

**Git**
- Контроль версий
- GitHub для хостинга

**Railway CLI**
- Деплой приложения
- Просмотр логов
- Управление переменными окружения

**Docker (опционально)**
- Локальное тестирование
- Репликация окружения Railway

**VS Code / Cursor**
- IDE для разработки
- Extensions:
  - Python
  - ShellCheck
  - GitLens

---

### Инфраструктурные инструменты

**OpenWrt**
- Cron: встроенный планировщик
- wget/curl: HTTP клиенты
- logger: системное логирование

**Railway**
- Nixpacks: автоматический buildpack
- PostgreSQL: для хранения истории (опционально)
- Redis: для кэширования (опционально)

**GitHub**
- Actions: CI/CD (опционально для автотестов)
- Releases: CDN для файлов
- API: программное управление

---

## 🔐 Безопасность

### Секреты и токены

**GitHub Personal Access Token**
- Scope: `repo` (полный доступ к репозиторию)
- Хранение: Railway environment variables
- Ротация: раз в год (или при компрометации)
- Название переменной: `GITHUB_TOKEN`

**Telegram Bot Token**
- Получение: @BotFather
- Хранение: Railway environment variables
- Формат: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`
- Название переменной: `TELEGRAM_BOT_TOKEN`

**Telegram Chat ID**
- Получение: @userinfobot
- Хранение: Railway environment variables
- Формат: `123456789`
- Название переменной: `TELEGRAM_CHAT_ID`

**Webhook Secret Token**
- Генерация: `openssl rand -hex 32`
- Хранение: 
  - Railway: environment variable `WEBHOOK_SECRET`
  - Роутер: в скрипте (file permissions 600)
- Использование: проверка подлинности webhook запросов

---

### Защита endpoints

**Webhook endpoint (`/webhook/geosite-update`)**

```python
@app.route('/webhook/geosite-update', methods=['POST'])
def handle_router_webhook():
    # Проверка Authorization header
    auth_header = request.headers.get('Authorization')
    expected_token = f"Bearer {os.getenv('WEBHOOK_SECRET')}"
    
    if auth_header != expected_token:
        logger.warning(f"Unauthorized webhook attempt from {request.remote_addr}")
        return jsonify({"error": "unauthorized"}), 401
    
    # Проверка Content-Type
    if request.content_type != 'application/json':
        return jsonify({"error": "invalid content type"}), 400
    
    # Валидация payload
    data = request.json
    if not data or 'commit' not in data:
        return jsonify({"error": "invalid payload"}), 400
    
    # Обработка запроса
    ...
```

**Rate limiting (опционально):**
```python
from flask_limiter import Limiter

limiter = Limiter(app, key_func=lambda: request.remote_addr)

@limiter.limit("10 per hour")
@app.route('/webhook/geosite-update', methods=['POST'])
def handle_router_webhook():
    ...
```

---

### Безопасность роутера

**Файл со скриптом:**
```bash
# Права доступа
chmod 700 /root/check_geosite_updates.sh
chown root:root /root/check_geosite_updates.sh

# Секреты внутри скрипта НЕ видны другим пользователям
```

**SSH доступ:**
- Только по ключу (отключить пароль)
- Firewall: SSH только из локальной сети
- Регулярное обновление OpenWrt

**OpenClash:**
- Dashboard защищен паролем LuCI
- HTTPS для веб-интерфейса (опционально)

---

### Безопасность данных

**Логирование:**
- НЕ логировать токены и секреты
- Фильтрация чувствительных данных в логах
- Ротация логов (не хранить бесконечно)

**GitHub Releases:**
- Публичный репозиторий: только geosite.dat (не секретная информация)
- Приватный репозиторий: если хотите скрыть какие категории используете

**Telegram:**
- Bot token не шарить публично
- Chat ID не критичен (можно только писать вам)

---

### Аудит безопасности

**Чеклист:**
- [ ] Все токены в environment variables (не в коде)
- [ ] Webhook защищен secret token
- [ ] HTTPS для всех внешних запросов
- [ ] Валидация всех входных данных
- [ ] Rate limiting на endpoints
- [ ] Логи не содержат секреты
- [ ] Права доступа на файлы корректные
- [ ] Регулярное обновление зависимостей

---

## 💰 Стоимость и экономика

### Детальный расчет

**Railway (основная стоимость):**

```
Сценарий: 30 проверок/мес, 4 сборки/мес, 8640 monitoring webhooks/мес

Проверка geosite (webhook обработка):
├─ Время: 5 секунд
├─ RAM: 100 МБ
├─ CPU: 10%
├─ Частота: 30 раз/мес
└─ Стоимость: ~$0.05/мес

Сборка (тяжелая операция):
├─ Время: 3-5 минут
├─ RAM: 500 МБ (пиковая)
├─ CPU: 100% (пиковая)
├─ Частота: 4 раза/мес
├─ Суммарно: 20 минут/мес
└─ Стоимость: ~$0.45/мес

Мониторинг ⚡ НОВОЕ (легкая нагрузка):
├─ Прием webhooks: 288/день * 30 = 8,640/мес
├─ Время обработки: 0.1 сек/webhook
├─ RAM: 150 МБ (+ хранение 24ч истории)
├─ CPU: 5%
├─ Суммарное время работы: 14.4 мин/мес
├─ Хранение метрик: в памяти (~100 КБ)
├─ Dashboard запросов: ~20/мес * 1 сек = 20 сек
└─ Стоимость: ~$0.15-0.25/мес

Idle time (бот спит между запросами):
├─ RAM: 0 МБ (контейнер остановлен)
├─ CPU: 0%
└─ Стоимость: $0/мес (!)

Network:
├─ Geosite webhook: ~1 КБ * 30 = 30 КБ
├─ Monitoring webhooks: ~0.5 КБ * 8,640 = 4.3 МБ  ⚡
├─ Alert webhooks: ~1 КБ * 10 = 10 КБ  ⚡
├─ Telegram (geosite): ~10 КБ * 10 = 100 КБ
├─ Telegram (monitoring): ~5 КБ * 30 = 150 КБ  ⚡
├─ Dashboard requests: ~10 КБ * 20 = 200 КБ  ⚡
├─ Git clone: ~150 МБ * 4 = 600 МБ
├─ GitHub upload: ~3 МБ * 4 = 12 МБ
├─ Суммарно: ~620 МБ/мес
└─ Стоимость: ~$0.08-0.10/мес

ИТОГО Railway: $0.70-1.00/мес (с мониторингом)
                $0.50-0.60/мес (без мониторинга)
```

**GitHub (бесплатно):**
- Releases storage: unlimited
- Bandwidth: unlimited для public repos
- API calls: 5000/hour (более чем достаточно)
- Cost: **$0/мес**

**Telegram (бесплатно):**
- Bot API: бесплатно
- Messages: unlimited
- Cost: **$0/мес**

**Роутер (уже оплачено):**
- Электричество: ~5-10 Вт * 24ч * 30д ≈ 3.6-7.2 кВт*ч
- Стоимость: ~20-40₽/мес (но роутер и так работает 24/7)
- Дополнительные затраты: **$0/мес**

---

### Сравнение с альтернативами

| Решение | Стоимость/мес | Удобство | Экономия RAM | Мониторинг | Итого |
|---------|---------------|----------|--------------|------------|-------|
| **Роутер + Railway** | $0.70-1.00 | 10/10 | 70-80 МБ | ✅ Полный | 🏆 **ВЫБОР** |
| Все на Railway 24/7 | $7-10 | 10/10 | 70-80 МБ | ✅ Полный | Дороже |
| VPS (Hetzner) | €4.5 (~$5) | 6/10 | 70-80 МБ | ⚠️ Ручной | Сложнее |
| GitHub Actions + Railway | $1.50-3 | 9/10 | 70-80 МБ | ⚠️ Частичный | Хорошо |
| Oracle Cloud Free | $0 | 4/10 | 70-80 МБ | ❌ Нет | Сложная настройка |
| Яндекс Cloud (текущее) | 1800₽ (~$19) | 5/10 | 0 МБ | ❌ Нет | ❌ Дорого |

---

### Экономия

**Переход с Яндекс Cloud на Railway:**
```
Было: 1800₽/мес (~$19/мес)
Стало: $0.70-1/мес (~63-90₽/мес)  [с мониторингом]

Экономия: 1710-1737₽/мес
Годовая экономия: 20,520-20,844₽/год
```

**Дополнительная ценность:**
- ✅ Удобство (Railway vs Яндекс CLI)
- ✅ Экономия времени (автоматизация)
- ✅ Экономия RAM роутера (стабильность)
- ✅ **Мониторинг 24/7** (контроль без SSH) ⚡ НОВОЕ
- ✅ **Проактивные алерты** (решение проблем до падения) ⚡ НОВОЕ
- ✅ **Дашборд в Telegram** (без веб-интерфейса) ⚡ НОВОЕ
- ✅ Обучение (опыт работы с современным PaaS)

**ROI (Return on Investment):**
- Время настройки: 6-8 часов (с мониторингом)
- Экономия: 1720₽/мес
- Окупаемость: мгновенная (с первого месяца)
- **Предотвращение падений:** бесценно! ⚡

**Ценность мониторинга:**
- Предотвращение 1 падения роутера = экономия 2+ часов времени
- Среднее количество проблем без мониторинга: 2-4/мес
- С мониторингом: раннее обнаружение и быстрое решение
- Экономия времени: 4-8 часов/мес = ~4000-8000₽ в эквиваленте

---

## 📅 План разработки

### Фаза 1: Подготовка (1-2 часа)

**Задачи:**
- [x] Создание документации проекта (этот файл)
- [ ] Регистрация на Railway
- [ ] Создание GitHub репозитория `custom-geosite`
- [ ] Создание Telegram бота (@BotFather)
- [ ] Генерация GitHub Personal Access Token
- [ ] Генерация webhook secret token

**Deliverables:**
- GitHub repo: `github.com/USERNAME/custom-geosite`
- Telegram bot: `@YourGeositeBot`
- Токены и секреты: сохранены в безопасном месте

---

### Фаза 2: Разработка Railway приложения (3-4 часа)

**Задачи:**
- [ ] Создание структуры проекта
  - [ ] `app.py` - главное приложение
  - [ ] `builder.py` - модуль сборки
  - [ ] `github_api.py` - GitHub интеграция
  - [ ] `config.py` - конфигурация
  - [ ] `requirements.txt` - зависимости
- [ ] Реализация webhook endpoint
- [ ] Реализация Telegram бота
  - [ ] Команды: /start, /status, /check, /build, /history
  - [ ] Обработка кнопок
  - [ ] Форматирование сообщений
- [ ] Реализация модуля сборки
  - [ ] Git clone logic
  - [ ] Go build integration
  - [ ] Checksum calculation
- [ ] Реализация GitHub API
  - [ ] Create release
  - [ ] Upload assets
  - [ ] Get commit info
- [ ] Обработка ошибок и логирование
- [ ] Тестирование локально

**Deliverables:**
- Working Railway application (локально)
- Все основные функции реализованы

---

### Фаза 3: Развертывание на Railway (1 час)

**Задачи:**
- [ ] Push кода в GitHub
- [ ] Подключение репозитория к Railway
- [ ] Настройка environment variables
  - [ ] `TELEGRAM_BOT_TOKEN`
  - [ ] `TELEGRAM_CHAT_ID`
  - [ ] `GITHUB_TOKEN`
  - [ ] `GITHUB_REPO`
  - [ ] `WEBHOOK_SECRET`
- [ ] Первый deploy
- [ ] Проверка логов
- [ ] Тестирование endpoints

**Deliverables:**
- Railway app: `https://geosite-bot.railway.app`
- Все переменные настроены
- Приложение работает

---

### Фаза 4: Разработка скрипта для роутера (1 час)

**Задачи:**
- [ ] Написание `check_geosite_updates.sh`
- [ ] Добавление конфигурации (webhook URL, secret)
- [ ] Тестирование локально (на Mac)
- [ ] Загрузка на роутер
- [ ] Настройка прав доступа (chmod 700)
- [ ] Тестирование на роутере
- [ ] Настройка crontab

**Deliverables:**
- Скрипт на роутере: `/root/check_geosite_updates.sh`
- Cron настроен: `0 3 * * *`
- Логи: `/tmp/geosite_check.log`

---

### Фаза 5: Первая сборка и тестирование (1-2 часа)

**Задачи:**
- [ ] Определение списка нужных категорий
  - [ ] category-ads-all
  - [ ] google
  - [ ] youtube
  - [ ] apple
  - [ ] netflix
  - [ ] ... (другие)
- [ ] Конфигурация списка в `config.py`
- [ ] Ручной запуск проверки (тест)
- [ ] Ручной запуск сборки через Telegram
- [ ] Проверка что Release создался
- [ ] Проверка размера файла (~3-5 МБ)
- [ ] Тестирование скачивания роутером

**Deliverables:**
- Первый релиз: `v2024.11.07.xx`
- geosite.dat работает на роутере
- Размер ~3-5 МБ (вместо 25 МБ)

---

### Фаза 6: Настройка OpenClash автообновления (30 минут)

**Задачи:**
- [ ] Открыть OpenClash UI
- [ ] Plugin Settings → Overwrite Settings
- [ ] Настроить GeoSite Database URL
  - [ ] `https://github.com/USERNAME/custom-geosite/releases/latest/download/geosite.dat`
- [ ] Включить Auto Update
- [ ] Настроить расписание (Weekly, Sunday, 03:00)
- [ ] Сохранить конфигурацию
- [ ] Перезапустить OpenClash
- [ ] Проверить что все работает

**Deliverables:**
- OpenClash настроен
- Автообновление активно
- Правила работают

---

### Фаза 7: Разработка мониторинга роутера ⚡ НОВАЯ (2-3 часа)

**Задачи:**
- [ ] Написание `monitor_router.sh`
  - [ ] Сбор метрик RAM
  - [ ] Сбор метрик CPU
  - [ ] Подсчет подключений WiFi
  - [ ] Проверка статуса OpenClash
  - [ ] Проверка критических порогов
  - [ ] Отправка данных на Railway
- [ ] Обновление Railway приложения
  - [ ] Добавление endpoint `/webhook/monitoring`
  - [ ] Добавление endpoint `/webhook/alert`
  - [ ] Хранилище метрик (24ч в памяти)
  - [ ] Генератор дашборда
  - [ ] Анализатор трендов
- [ ] Добавление команд в Telegram бот
  - [ ] `/dashboard` - полный дашборд
  - [ ] `/monitor` - быстрый обзор
  - [ ] `/alerts` - история алертов
- [ ] Тестирование
  - [ ] Нормальный сценарий (все в порядке)
  - [ ] Критический сценарий (RAM >85%)
  - [ ] Проверка дашборда
- [ ] Загрузка скрипта на роутер
- [ ] Настройка crontab (каждые 5 минут)
- [ ] Настройка прав доступа (chmod 700)

**Deliverables:**
- Скрипт на роутере: `/root/monitor_router.sh`
- Cron настроен: `*/5 * * * *` (каждые 5 минут)
- Логи на Railway (не на роутере!)
- Dashboard доступен по команде
- Алерты работают при критических значениях

---

### Фаза 8: Мониторинг и оптимизация (ongoing)

**Задачи:**
- [ ] Мониторинг работы системы (неделя)
- [ ] Анализ логов Railway
- [ ] Анализ логов роутера
- [ ] Проверка стоимости Railway
- [ ] Оптимизация если нужно
- [ ] Документирование проблем и решений
- [ ] Добавление дополнительных категорий (если нужно)

**Deliverables:**
- Стабильно работающая система
- Понимание реальной стоимости
- Список улучшений (если есть)

---

### Итого времени

**Общее время разработки: 10-15 часов (с мониторингом)**

**Распределение:**
- Подготовка: 1-2 часа
- Разработка geosite: 4-5 часов
- Разработка мониторинга: 2-3 часа ⚡ НОВОЕ
- Деплой и настройка: 2-3 часа
- Тестирование: 1-2 часа

**График:**
- День 1 (4 часа): Фазы 1-2 (Подготовка + Разработка)
- День 2 (5 часов): Фазы 3-5 (Деплой + Geosite)
- День 3 (3 часа): Фазы 6-7 (OpenClash + Мониторинг)
- День 4+ (ongoing): Фаза 8 (Мониторинг системы)

**Опционально (без мониторинга):**
- Время: 8-12 часов
- Фазы 1-6 + начало фазы 8

---

## 📊 Мониторинг и поддержка

### Логирование ⚡ ОБНОВЛЕНО

**Философия хранения логов:**
- ❌ **НЕ на роутере** - ограниченная память
- ✅ **На Railway** - неограниченное место, удобный просмотр
- ✅ **В памяти** - последние 24 часа для дашборда
- ✅ **В Telegram** - критические события

**Роутер (минимальное логирование):**

Только для отладки на месте:
```bash
# /tmp/geosite_check.log (ротация каждые 24ч)
[2024-11-07 03:00:05] Starting geosite update check
[2024-11-07 03:00:12] Webhook sent successfully

# /tmp/monitor.log (последние 10 записей)
[2024-11-07 15:00] RAM: 51% | CPU: 0.45 | Status: OK
[2024-11-07 15:05] RAM: 52% | CPU: 0.48 | Status: OK
```

**Railway (основное хранение) ⚡ НОВОЕ:**

Все логи хранятся здесь:
```json
// Мониторинг метрики
{
  "timestamp": "2024-11-07T15:00:06Z",
  "type": "monitoring",
  "level": "info",
  "data": {
    "ram": {"percent": 51, "used": 126, "free": 77},
    "cpu": {"load1": 0.45, "load5": 0.52, "load15": 0.38},
    "clients": 8,
    "openclash": {"status": "running", "memory": 1234},
    "source": "router"
  }
}

// Критический алерт
{
  "timestamp": "2024-11-07T15:30:15Z",
  "type": "alert",
  "level": "critical",
  "data": {
    "alert_type": "ram",
    "value": 89,
    "threshold": 85,
    "message": "RAM критично!",
    "action_taken": "telegram_notification",
    "source": "router"
  }
}

// Geosite webhook
{
  "timestamp": "2024-11-07T03:00:12Z",
  "type": "geosite_update",
  "level": "info",
  "data": {
    "commit": "abc123",
    "old_commit": "xyz789",
    "source_ip": "123.45.67.89"
  }
}
```

**Хранение истории метрик в Railway:**

```python
# В памяти (быстрый доступ)
metrics_history = {
  "timestamps": [...],  # Последние 288 записей (24ч * 12/час)
  "ram_percent": [...],
  "cpu_load1": [...],
  "clients": [...],
  "openclash_memory": [...],
}

# Размер в памяти: ~50-100 КБ
# При перезапуске Railway: данные теряются (не критично)
# Для долгосрочного хранения: можно добавить PostgreSQL (опционально)
```

**Преимущества хранения на Railway:**
- ✅ Не занимает место на роутере (экономия памяти)
- ✅ Удобный веб-просмотр логов
- ✅ Поиск и фильтрация
- ✅ Интеграция с дашбордом
- ✅ Бесконечная история (Railway logs retention)

**Просмотр логов:**
```bash
# Локально через Railway CLI
railway logs

# Веб-интерфейс Railway
https://railway.app/project/YOUR_PROJECT/logs

# Через Telegram бот (команды)
/alerts  # История алертов за 24ч
/dashboard  # Дашборд с метриками
```

**OpenClash логи (остаются на роутере):**
```
# Только для отладки OpenClash
[2024-11-10 03:00:30] Starting GeoSite update...
[2024-11-10 03:00:45] Downloaded: geosite.dat (3.4 MB)
[2024-11-10 03:00:50] Update successful
[2024-11-10 03:00:55] Clash restarted
```

---

### Метрики для отслеживания

**Частота обновлений:**
- Проверок: ~30/мес (ежедневно)
- Обновлений найдено: ~4-8/мес
- Сборок запущено: ~4-8/мес (пользователь может пропустить)

**Производительность:**
- Время проверки: <15 сек
- Время сборки: 3-5 мин
- Время публикации: <10 сек
- Время обновления роутера: 1-2 мин

**Надежность:**
- Успешных проверок: >95%
- Успешных сборок: >90%
- Uptime Railway: >99%
- Uptime роутера: >99.5%

**Стоимость:**
- Railway: $0.50-2/мес
- Целевой бюджет: <$3/мес
- Превышение бюджета: alert

---

### Алерты и уведомления

**Критичные (немедленно):**
- ❌ Сборка упала с ошибкой
- ❌ Публикация в GitHub failed
- ❌ Роутер не может скачать файл
- ❌ Railway billing превысил $5/мес

**Важные (в течение дня):**
- ⚠️ Проверка не прошла 3 раза подряд
- ⚠️ Скрипт на роутере не запускался >48 часов
- ⚠️ OpenClash не обновлялся >2 недель

**Информационные:**
- ℹ️ Новая версия собрана успешно
- ℹ️ Роутер обновился
- ℹ️ Статистика за месяц

---

### Troubleshooting

**Проблема: Роутер не отправляет webhook**

Диагностика:
```bash
# На роутере
cat /tmp/geosite_check.log  # Проверить логи
crontab -l  # Проверить crontab
curl -v https://geosite-bot.railway.app/health  # Проверить доступность Railway
```

Решения:
- Проверить интернет соединение роутера
- Проверить что Railway app не спит
- Проверить webhook URL в скрипте
- Проверить secret token

**Проблема: Сборка падает с ошибкой**

Диагностика:
- Проверить логи Railway
- Проверить доступность domain-list-community
- Проверить версию Go

Решения:
- Перезапустить сборку
- Обновить зависимости
- Увеличить timeout

**Проблема: Роутер не обновляется**

Диагностика:
```bash
# В OpenClash UI проверить:
# - URL правильный?
# - Auto update включен?
# - Расписание корректное?
# - Последнее обновление когда было?
```

Решения:
- Ручной запуск обновления в OpenClash UI
- Проверить файрвол
- Проверить что Release существует на GitHub

---

### Обслуживание

**Еженедельно:**
- Проверить что система работает (визуально)
- Проверить логи на ошибки

**Ежемесячно:**
- Проверить стоимость Railway
- Проверить количество обновлений
- Проверить размер geosite.dat (не вырос ли?)
- Обновить список категорий (если нужно)

**Ежеквартально:**
- Обновить зависимости Python
- Проверить безопасность (audit)
- Ротация токенов (опционально)
- Бэкап конфигурации

**Ежегодно:**
- Полный review системы
- Оценка альтернатив (может появилось что-то лучше?)
- Обновление документации

---

## 📝 Чеклист перед запуском

### Подготовка

- [ ] Railway аккаунт создан
- [ ] GitHub репозиторий создан
- [ ] Telegram бот создан (@BotFather)
- [ ] Все токены сгенерированы:
  - [ ] GitHub Personal Access Token
  - [ ] Telegram Bot Token
  - [ ] Webhook Secret Token
- [ ] Список нужных категорий определен

### Разработка

- [ ] Railway приложение написано
- [ ] Скрипт для роутера написан
- [ ] Все зависимости указаны
- [ ] Обработка ошибок реализована
- [ ] Логирование настроено

### Деплой

- [ ] Railway app задеплоено
- [ ] Environment variables настроены
- [ ] Webhook endpoint работает
- [ ] Telegram бот отвечает
- [ ] Скрипт загружен на роутер
- [ ] Cron настроен на роутере
- [ ] OpenClash автообновление настроено

### Тестирование

- [ ] Проверка вручную работает
- [ ] Webhook от роутера работает
- [ ] Telegram уведомления приходят
- [ ] Сборка запускается кнопкой
- [ ] Release создается в GitHub
- [ ] Роутер может скачать файл
- [ ] OpenClash применяет обновление
- [ ] Правила работают корректно

### Документация

- [ ] README.md в репозитории
- [ ] Инструкция по установке
- [ ] Примеры конфигурации
- [ ] Troubleshooting guide
- [ ] Changelog

### Безопасность

- [ ] Токены не в коде
- [ ] Webhook защищен
- [ ] Права на файлы корректные
- [ ] HTTPS везде
- [ ] Валидация входных данных

---

## 🎯 Критерии успеха

### Технические

- ✅ Система работает без вмешательства >30 дней
- ✅ Роутер стабильно работает (нет зависаний)
- ✅ RAM роутера освобождено 70-80 МБ
- ✅ Обновления применяются автоматически
- ✅ Стоимость <$3/мес

### Пользовательские

- ✅ Уведомления приходят вовремя
- ✅ Управление через Telegram удобно
- ✅ Не нужно заходить на роутер вручную
- ✅ Понятно что происходит (прозрачность)
- ✅ Можно легко откатиться (history в GitHub)

### Бизнес

- ✅ Экономия 1600₽/мес (vs Яндекс Cloud)
- ✅ Экономия времени >2 часов/мес (vs ручное управление)
- ✅ Обучение новым технологиям (Railway, Python bot)
- ✅ Портфолио проект (можно показать)

---

## 📚 Полезные ссылки

### Документация

- **Railway:** https://docs.railway.app/
- **Telegram Bot API:** https://core.telegram.org/bots/api
- **GitHub API:** https://docs.github.com/en/rest
- **OpenWrt:** https://openwrt.org/docs/start
- **OpenClash:** https://github.com/vernesong/OpenClash/wiki

### Upstream проекты

- **domain-list-community:** https://github.com/v2fly/domain-list-community
- **v2ray-core:** https://github.com/v2fly/v2ray-core
- **Clash Meta:** https://github.com/MetaCubeX/Clash.Meta

### Инструменты

- **python-telegram-bot:** https://python-telegram-bot.org/
- **PyGithub:** https://pygithub.readthedocs.io/
- **Flask:** https://flask.palletsprojects.com/

---

## 🔄 История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2024-11-07 | 1.0 | Первая версия документации |

---

## 👤 Контакты и поддержка

**Автор проекта:** [Ваше имя]

**Вопросы:** Telegram @yourusername

**Issues:** GitHub Issues в репозитории

---

## 📄 Лицензия

MIT License - используйте как хотите!

---

**Статус:** ✅ Готов к разработке

**Следующий шаг:** Фаза 1 - Подготовка

**ETA до production:** 2-3 дня (8-12 часов работы)


