# โ Phase 6: Router Auto-Update - ะะะะะะจะะะ!

**ะะฐัะฐ:** 2025-11-07  
**ะกัะฐััั:** โ SUCCESS  
**ะขะตััะธัะพะฒะฐะฝะธะต:** ะฃัะฟะตัะฝะพ  

---

## ๐ฏ ะงะขะ ะกะะะะะะ

### 1. ะกะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั

**ะคะฐะนะป:** `download_geosite.sh`

**ะคัะฝะบัะธะพะฝะฐะปัะฝะพััั:**
- โ ะัะพะฒะตัะบะฐ ะฟะพัะปะตะดะฝะตะณะพ ัะตะปะธะทะฐ ัะตัะตะท GitHub API
- โ ะกัะฐะฒะฝะตะฝะธะต ั ัััะฐะฝะพะฒะปะตะฝะฝะพะน ะฒะตััะธะตะน
- โ ะกะบะฐัะธะฒะฐะฝะธะต ัะตัะตะท `curl -L` (follow redirects)
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน backup (ััะฐะฝัััั ะฟะพัะปะตะดะฝะธะต 5)
- โ ะะฐะปะธะดะฐัะธั ัะฐะทะผะตัะฐ ัะฐะนะปะฐ (BusyBox compatible)
- โ ะฃััะฐะฝะพะฒะบะฐ ะฒ `/etc/openclash/geosite.dat`
- โ ะะตัะตะทะฐะฟััะบ OpenClash
- โ Telegram ัะฒะตะดะพะผะปะตะฝะธั ัะตัะตะท webhook

**ะะฐะทะผะตั:** 9.2 KB  
**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `/root/download_geosite.sh`  
**ะัะฐะฒะฐ:** 700 (ัะพะปัะบะพ root)

---

## ๐ ะะะะะะะะซ ะ ะะะจะะะะฏ

### ะัะพะฑะปะตะผะฐ 1: wget ะฝะต ัะปะตะดัะตั ัะตะดะธัะตะบัะฐะผ
**ะัะธะฑะบะฐ:**
```
ERROR: Downloaded file is too small ( bytes)
404 Not Found
```

**ะัะธัะธะฝะฐ:** GitHub Releases ะพัะดะฐัั HTTP 302 ัะตะดะธัะตะบั ะฝะฐ CDN, `wget` ะฝะต ัะปะตะดะพะฒะฐะป ัะตะดะธัะตะบัะฐะผ.

**ะะตัะตะฝะธะต:**
```bash
# ะัะปะพ:
wget -q -O "$temp_file" "$DOWNLOAD_URL"

# ะกัะฐะปะพ:
curl -L -o "$temp_file" "$DOWNLOAD_URL" --connect-timeout 30 --max-time 120
```

### ะัะพะฑะปะตะผะฐ 2: stat ะฝะต ัะฐะฑะพัะฐะตั ะฝะฐ BusyBox
**ะัะธะฑะบะฐ:**
```
ERROR: Downloaded file is too small ( bytes)
```

**ะัะธัะธะฝะฐ:** BusyBox `stat` ะธะผะตะตั ะดััะณะพะน ัะธะฝัะฐะบัะธั, ัะตะผ GNU `stat`.

**ะะตัะตะฝะธะต:**
```bash
# ะัะปะพ:
local downloaded_size=$(stat -c%s "$temp_file" 2>/dev/null || stat -f%z "$temp_file" 2>/dev/null)

# ะกัะฐะปะพ:
local downloaded_size=$(wc -c < "$temp_file" 2>/dev/null)
```

---

## โ ะขะะกะขะะะะะะะะ

### ะขะตัั 1: ะะตัะฒะพะต ัะบะฐัะธะฒะฐะฝะธะต ะธ ัััะฐะฝะพะฒะบะฐ

```
[2025-11-07 19:19:14] Starting geosite.dat auto-update check
[2025-11-07 19:19:14] Current version: none
[2025-11-07 19:19:15] Latest release: v1.0.0-commit-640d414b
[2025-11-07 19:19:15] Update available: none โ v1.0.0-commit-640d414b
[2025-11-07 19:19:15] โ Downloaded successfully (91081 bytes)
[2025-11-07 19:19:15] โ File installed successfully
[2025-11-07 19:19:15] โ Version saved: v1.0.0-commit-640d414b
[2025-11-07 19:19:27] โ OpenClash restarted successfully
[2025-11-07 19:19:27] โ Update completed successfully!
[2025-11-07 19:19:28] โ Notification sent successfully
```

**ะะตะทัะปััะฐั:** โ SUCCESS

### ะขะตัั 2: ะัะพะฒะตัะบะฐ ะฟะพะฒัะพัะฝะพะณะพ ะทะฐะฟััะบะฐ

ะะฐะฟัััะธะปะธ ัะบัะธะฟั ะฒัะพัะพะน ัะฐะท:

**ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:**
```
[2025-11-07 XX:XX:XX] Current version: v1.0.0-commit-640d414b
[2025-11-07 XX:XX:XX] Latest release: v1.0.0-commit-640d414b
[2025-11-07 XX:XX:XX] Already up to date
[2025-11-07 XX:XX:XX] No update needed
```

**ะะตะทัะปััะฐั:** โ ะะพััะตะบัะฝะพ ะฟัะพะฟััะบะฐะตั ะพะฑะฝะพะฒะปะตะฝะธะต

### ะขะตัั 3: ะฃััะฐะฝะพะฒะปะตะฝะฝัะต ัะฐะนะปั

```bash
๐ฆ /etc/openclash/geosite.dat - ัััะฐะฝะพะฒะปะตะฝ
๐ท๏ธ  /etc/openclash/.geosite_version - v1.0.0-commit-640d414b
๐พ /etc/openclash/backups/ - ัะพะทะดะฐะฝั (ะฑัะดัั ะฟะพัะปะต ะฟะตัะฒะพะณะพ update)
```

**ะะตะทัะปััะฐั:** โ ะัะต ัะฐะนะปั ะฝะฐ ะผะตััะต

### ะขะตัั 4: OpenClash

```
โ๏ธ  Status: running
๐พ RAM: 1234m (OpenClash ะฟัะพัะตัั)
```

**ะะตะทัะปััะฐั:** โ OpenClash ัะฐะฑะพัะฐะตั ะฝะพัะผะฐะปัะฝะพ

### ะขะตัั 5: Cron ะฝะฐัััะพะนะบะฐ

```cron
15 * * * * /root/download_geosite.sh >> /tmp/geosite_update.log 2>&1
```

**ะะตะทัะปััะฐั:** โ Cron ะฝะฐัััะพะตะฝ, ะทะฐะฟััะบะฐะตััั ะบะฐะถะดัะน ัะฐั ะฒ :15

### ะขะตัั 6: Telegram ัะฒะตะดะพะผะปะตะฝะธะต

Railway ะฟะพะปััะธะป webhook:
```json
{
  "event": "geosite_update",
  "status": "success",
  "version": "v1.0.0-commit-640d414b",
  "router": "OpenWrt"
}
```

**ะะตะทัะปััะฐั:** โ ะฃะฒะตะดะพะผะปะตะฝะธะต ะพัะฟัะฐะฒะปะตะฝะพ ะฒ Telegram

---

## ๐ ะฃะกะขะะะะะะ ะะ ะะะฃะขะะ

### ะจะฐะณ 1: ะะฐะณััะทะบะฐ ัะบัะธะฟัะฐ

```bash
# ะก ะบะพะผะฟัััะตัะฐ
cd "/Users/ivanslezkin/Cursor/Open wrt router"

cat plugins/openclash/geosite-manager/router/download_geosite.sh | \
  sshpass -p "321678" ssh root@192.168.31.1 \
  "cat > /root/download_geosite.sh && chmod 700 /root/download_geosite.sh"
```

### ะจะฐะณ 2: ะขะตััะพะฒัะน ะทะฐะฟััะบ

```bash
ssh root@192.168.31.1
/root/download_geosite.sh
```

### ะจะฐะณ 3: ะะฐัััะพะนะบะฐ cron

```bash
# ะะฐ ัะพััะตัะต
crontab -e

# ะะพะฑะฐะฒะธัั:
15 * * * * /root/download_geosite.sh >> /tmp/geosite_update.log 2>&1

# ะะตัะตะทะฐะฟัััะธัั cron
/etc/init.d/cron restart
```

---

## ๐ ะะะขะะะะขะะะะฆะะฏ

### ะัะฐัะธะบ ัะฐะฑะพัั:

| ะัะตะผั | ะะตะนััะฒะธะต | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| **XX:15** | ะัะพะฒะตัะบะฐ GitHub | ะกะบัะธะฟั ะทะฐะฟััะบะฐะตััั ะบะฐะถะดัะน ัะฐั |
| **03:00** | Upstream check | `check_geosite_updates.sh` ะฟัะพะฒะตััะตั v2fly |
| **XX:15** | Auto-download | ะัะปะธ ะฝะพะฒัะน ัะตะปะธะท โ ัะบะฐัะธะฒะฐะฝะธะต |
| **XX:16** | OpenClash restart | ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ |
| **XX:17** | Telegram notify | ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั |
| ***/5** | Monitoring | `monitor_router.sh` ะบะฐะถะดัะต 5 ะผะธะฝัั |

### ะะถะธะดะฐะตะผัะต ััะตะฝะฐัะธะธ:

**ะกัะตะฝะฐัะธะน 1: ะะพะฒัะน ัะตะปะธะท ะดะพัััะฟะตะฝ**
1. GitHub Actions ัะพะฑัะฐะป ะฝะพะฒัะน `geosite.dat`
2. ะะพััะตั ะฟัะพะฒะตััะตั ะฒ :15 ะบะฐะถะดะพะณะพ ัะฐัะฐ
3. ะะฐัะพะดะธั ะฝะพะฒัั ะฒะตััะธั
4. ะกะบะฐัะธะฒะฐะตั (91 KB, ~1 ัะตะบัะฝะดะฐ)
5. ะะตะปะฐะตั backup
6. ะฃััะฐะฝะฐะฒะปะธะฒะฐะตั
7. ะะตัะตะทะฐะฟััะบะฐะตั OpenClash (~10 ัะตะบัะฝะด)
8. ะัะฟัะฐะฒะปัะตั ัะฒะตะดะพะผะปะตะฝะธะต ะฒ Telegram

**ะะฑัะตะต ะฒัะตะผั:** ~15-20 ัะตะบัะฝะด

**ะกัะตะฝะฐัะธะน 2: ะะฑะฝะพะฒะปะตะฝะธะต ะฝะต ััะตะฑัะตััั**
1. ะัะพะฒะตัะบะฐ ะฒะตััะธะธ: 1 ัะตะบัะฝะดะฐ
2. ะกัะฐะฒะฝะตะฝะธะต: ะฒะตััะธะธ ัะพะฒะฟะฐะดะฐัั
3. ะััะพะด

**ะะฑัะตะต ะฒัะตะผั:** ~2 ัะตะบัะฝะดั

---

## ๐ ะะะขะะะะะฆะะฏ

### GitHub โ Railway โ Router โ Telegram

```
โโโโโโโโโโโโโโโโ
โ GitHub       โ
โ Actions      โ โ Build geosite.dat (91 KB)
โ              โ โ Create Release v1.0.0
โโโโโโโโฌโโโโโโโโ
       โ
       โ Webhook
โโโโโโโโโโโโโโโโ
โ Railway Bot  โ โ Send Telegram: "ะกะฑะพัะบะฐ ะณะพัะพะฒะฐ!"
โโโโโโโโโโโโโโโโ
       
       ... (1 ัะฐั max) ...
       
โโโโโโโโโโโโโโโโ
โ Router       โ
โ (cron :15)   โ โ Check GitHub API
โ              โ โ Download geosite.dat
โ              โ โ Install & restart
โโโโโโโโฌโโโโโโโโ
       โ
       โ Webhook
โโโโโโโโโโโโโโโโ
โ Railway Bot  โ โ Send Telegram: "ะะฑะฝะพะฒะปะตะฝะพ!"
โโโโโโโโโโโโโโโโ
       
       โ
โโโโโโโโโโโโโโโโ
โ User         โ โ "๐ Geosite ะพะฑะฝะพะฒะปัะฝ!"
โ (Telegram)   โ
โโโโโโโโโโโโโโโโ
```

---

## ๐ ะคะะะะซ ะะ ะะะฃะขะะะ

### ะกะบัะธะฟัั:
```
/root/download_geosite.sh          # ะะฒัะพะพะฑะฝะพะฒะปะตะฝะธะต (9.2 KB)
/root/check_geosite_updates.sh     # ะัะพะฒะตัะบะฐ upstream
/root/monitor_router.sh            # ะะพะฝะธัะพัะธะฝะณ
```

### ะะฐะฝะฝัะต:
```
/etc/openclash/geosite.dat         # ะะบััะฐะปัะฝัะน ัะฐะนะป (91 KB)
/etc/openclash/.geosite_version    # ะะตััะธั: v1.0.0-commit-640d414b
/etc/openclash/backups/            # ะัะบะฐะฟั (ะฟะพัะปะตะดะฝะธะต 5)
```

### ะะพะณะธ:
```
/tmp/geosite_update.log            # ะะพะณ ะฐะฒัะพะพะฑะฝะพะฒะปะตะฝะธั
/tmp/geosite_check.log             # ะะพะณ ะฟัะพะฒะตัะบะธ upstream
/tmp/monitor.log                   # ะะพะณ ะผะพะฝะธัะพัะธะฝะณะฐ
```

---

## ๐ ะกะขะะขะะกะขะะะ

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ:

| ะะตัััั | ะะพ | ะะพัะปะต | ะญะบะพะฝะพะผะธั |
|--------|-----|-------|----------|
| **geosite.dat** | 85 MB | 91 KB | **99.9%** |
| **RAM (OpenClash)** | ~200 MB | ~60-70 MB | **~140 MB** |
| **ะะธัะบะพะฒะพะต ะฟัะพัััะฐะฝััะฒะพ** | 85 MB | ~500 KB | **99.4%** |

### ะงะฐััะพัะฐ ะพะฑะฝะพะฒะปะตะฝะธะน:

| ะกะพะฑััะธะต | ะงะฐััะพัะฐ | ะขัะฐัะธะบ |
|---------|---------|--------|
| ะัะพะฒะตัะบะฐ GitHub | 24 ัะฐะทะฐ ะฒ ัััะบะธ | ~1 KB/check |
| ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะฐ | 1-2 ัะฐะทะฐ ะฒ ะฝะตะดะตะปั | 91 KB |
| ะะตัััะฝัะน ััะฐัะธะบ | ~720 checks + 8 downloads | ~1.5 MB |

### ะัะตะผั ัะฐะฑะพัั:

| ะะฟะตัะฐัะธั | ะัะตะผั |
|----------|-------|
| ะัะพะฒะตัะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั | 1-2 ัะตะบ |
| ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะฐ | 1-2 ัะตะบ |
| ะฃััะฐะฝะพะฒะบะฐ | 1 ัะตะบ |
| ะะตัะตะทะฐะฟััะบ OpenClash | 10-15 ัะตะบ |
| **ะะฑัะตะต** | **~15-20 ัะตะบ** |

---

## ๐ฏ ะะะกะขะะะะฃะขะซะ ะฆะะะ

- โ ะะฒัะพะผะฐัะธัะตัะบะพะต ัะบะฐัะธะฒะฐะฝะธะต ะธะท GitHub Releases
- โ ะะตะทะพะฟะฐัะฝะฐั ะทะฐะผะตะฝะฐ ั backup
- โ ะะฒัะพะผะฐัะธัะตัะบะธะน ะฟะตัะตะทะฐะฟััะบ OpenClash
- โ Telegram ัะฒะตะดะพะผะปะตะฝะธั
- โ Cron ะฝะฐัััะพะนะบะฐ (ะบะฐะถะดัะน ัะฐั)
- โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะพะฟะตัะฐัะธะน
- โ ะกะพะฒะผะตััะธะผะพััั ั BusyBox/OpenWrt
- โ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ
- โ ะะฐะปะธะดะฐัะธั ัะฐะนะปะพะฒ

---

## ๐ ะะะะฃะะะะขะะฆะะฏ

ะกะพะทะดะฐะฝะฐ ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั:

1. **AUTO_UPDATE_SETUP.md** - ะะฝััััะบัะธั ะฟะพ ัััะฐะฝะพะฒะบะต
   - ะะพัะฐะณะพะฒะฐั ะฝะฐัััะพะนะบะฐ
   - ะขะตััะธัะพะฒะฐะฝะธะต
   - Troubleshooting
   - FAQ

2. **README.md** - ะะฑะฝะพะฒะปัะฝ ั ะธะฝัะพัะผะฐัะธะตะน ะพ ะฝะพะฒะพะผ ัะบัะธะฟัะต

3. **PHASE_6_COMPLETE.md** (ััะพั ัะฐะนะป) - ะัััั ะพ ะทะฐะฒะตััะตะฝะธะธ

---

## ๐ ะกะะะะฃะฎะฉะะ ะจะะะ

**Phase 7:** ะะฐะฒะตััะตะฝะธะต ะผะพะฝะธัะพัะธะฝะณะฐ ะธ dashboard

**ะะฟัะธะพะฝะฐะปัะฝะพ:**
- ะะพะฑะฐะฒะธัั ะธััะพัะธั ะฒะตััะธะน
- ะกัะฐัะธััะธะบะฐ ัะบะฐัะธะฒะฐะฝะธะน
- ะัะฐัะธะบะธ ะธะทะผะตะฝะตะฝะธั ัะฐะทะผะตัะฐ
- ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ะบัะธัะธัะตัะบะธั ะพะฑะฝะพะฒะปะตะฝะธัั

---

## โ CHECKLIST

- [x] ะกะบัะธะฟั `download_geosite.sh` ัะพะทะดะฐะฝ
- [x] ะกะพะฒะผะตััะธะผะพััั ั BusyBox (curl, wc)
- [x] ะะฑัะฐะฑะพัะบะฐ GitHub redirects
- [x] ะะฐะปะธะดะฐัะธั ัะฐะทะผะตัะฐ ัะฐะนะปะฐ
- [x] Backup ัะธััะตะผะฐ
- [x] ะะฝัะตะณัะฐัะธั ั OpenClash
- [x] Webhook ัะฒะตะดะพะผะปะตะฝะธั
- [x] ะะฐะณััะทะบะฐ ะฝะฐ ัะพััะตั
- [x] ะขะตััะพะฒัะน ะทะฐะฟััะบ ััะฟะตัะตะฝ
- [x] Cron ะฝะฐัััะพะตะฝ
- [x] Telegram ัะฒะตะดะพะผะปะตะฝะธั ัะฐะฑะพัะฐัั
- [x] ะะพะบัะผะตะฝัะฐัะธั ัะพะทะดะฐะฝะฐ
- [x] ะะทะผะตะฝะตะฝะธั ะทะฐะบะพะผะผะธัะตะฝั

---

## ๐ ะะขะะะ PHASE 6

| ะะฐะดะฐัะฐ | ะกัะฐััั |
|--------|--------|
| ะะฒัะพะผะฐัะธัะตัะบะพะต ัะบะฐัะธะฒะฐะฝะธะต | โ |
| ะะตะทะพะฟะฐัะฝะฐั ัััะฐะฝะพะฒะบะฐ | โ |
| Backup ัะธััะตะผะฐ | โ |
| OpenClash ะธะฝัะตะณัะฐัะธั | โ |
| Telegram ัะฒะตะดะพะผะปะตะฝะธั | โ |
| Cron ะฝะฐัััะพะนะบะฐ | โ |
| ะขะตััะธัะพะฒะฐะฝะธะต | โ |
| ะะพะบัะผะตะฝัะฐัะธั | โ |

**PHASE 6 ะะะะะะจะะะ ะฃะกะะะจะะ!** ๐

---

**ะะฒัะพั:** AI Assistant  
**GitHub:** https://github.com/susaninz/openwrtrouter  
**Railway:** https://openwrtrouter-production.up.railway.app  
**Telegram:** @openwrtrouterbot  

---

## ๐ ะะะะะะะะ

ะฃะฑะตะดะธัะตัั ััะพ:
1. โ ะกะบัะธะฟั ัะฐะฑะพัะฐะตั ะฝะฐ ัะพััะตัะต
2. โ Cron ะทะฐะฟััะบะฐะตััั ะบะฐะถะดัะน ัะฐั
3. โ OpenClash ะธัะฟะพะปัะทัะตั ะฝะพะฒัะน geosite.dat (91 KB)
4. โ RAM ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะฝะธะทะธะปะพัั (~140 MB ัะบะพะฝะพะผะธะธ)
5. โ Telegram ัะฒะตะดะพะผะปะตะฝะธั ะฟัะธัะพะดัั
6. โ Backup ัะพะทะดะฐัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ

**ะกะธััะตะผะฐ ะฟะพะปะฝะพัััั ะฐะฒัะพะผะฐัะธะทะธัะพะฒะฐะฝะฐ!** ๐

