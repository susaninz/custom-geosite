name: Update VPN Proxy Providers

# ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ VPN-Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ (base64 VLESS) â†’ Clash YAML proxy-provider Ñ„Ð°Ð¹Ð»Ñ‹
# ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÑ‚ Ð² GitHub Releases ÐºÐ°Ðº sirius-providers.yaml Ð¸ x8-providers.yaml

on:
  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 04:00 UTC (07:00 MSK) â€” Ð¿Ð¾ÑÐ»Ðµ build-geosite (03:00 UTC)
  schedule:
    - cron: '0 4 * * *'

  # Ð’Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· GitHub UI
  workflow_dispatch:

env:
  RELEASE_TAG: vpn-providers-latest

jobs:
  update-providers:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install pyyaml
          mkdir -p build

      - name: ðŸ“¥ Download & convert Sirius subscription
        run: |
          curl -sL --max-time 30 \
            -H "User-Agent: clash.meta" \
            "${{ secrets.SIRIUS_SUB_URL }}" \
            -o /tmp/sirius_raw.txt

          if [ ! -s /tmp/sirius_raw.txt ]; then
            echo "::error::Failed to download Sirius subscription"
            exit 1
          fi

          python3 scripts/convert_vless_to_clash.py \
            --file /tmp/sirius_raw.txt \
            build/sirius-providers.yaml

      - name: ðŸ“¥ Download & convert X8 subscription
        run: |
          curl -sL --max-time 30 \
            -H "User-Agent: clash.meta" \
            "${{ secrets.X8_SUB_URL }}" \
            -o /tmp/x8_raw.txt

          if [ ! -s /tmp/x8_raw.txt ]; then
            echo "::warning::Failed to download X8 subscription, skipping"
            echo "x8_skipped=true" >> $GITHUB_ENV
          elif head -1 /tmp/x8_raw.txt | grep -q "<!DOCTYPE\|<html"; then
            echo "::warning::X8 subscription returned HTML (URL may be expired), skipping"
            echo "x8_skipped=true" >> $GITHUB_ENV
          elif head -1 /tmp/x8_raw.txt | grep -q "^mixed-port\|^port\|^proxies"; then
            # X8 returns full Clash YAML config â€” extract proxies section
            echo "X8 returned Clash YAML format, extracting proxies..."
            python3 -c "
          import yaml
          with open('/tmp/x8_raw.txt') as f:
              data = yaml.safe_load(f)
          proxies = data.get('proxies', [])
          if not proxies:
              raise ValueError('No proxies found in X8 Clash config')
          with open('build/x8-providers.yaml', 'w') as f:
              yaml.dump({'proxies': proxies}, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
          print(f'Extracted {len(proxies)} proxies from Clash YAML')
          "
            echo "x8_skipped=false" >> $GITHUB_ENV
          else
            # Try base64 decode
            python3 scripts/convert_vless_to_clash.py \
              --file /tmp/x8_raw.txt \
              build/x8-providers.yaml
            echo "x8_skipped=false" >> $GITHUB_ENV
          fi

      - name: âœ… Validate output
        run: |
          echo "=== Sirius providers ==="
          python3 -c "
          import yaml
          with open('build/sirius-providers.yaml') as f:
              data = yaml.safe_load(f)
          proxies = data.get('proxies', [])
          print(f'Servers: {len(proxies)}')
          for p in proxies:
              print(f'  - {p[\"name\"]} ({p[\"server\"]}:{p[\"port\"]})')
          assert len(proxies) > 0, 'No proxies found!'
          "

          if [ "$x8_skipped" != "true" ] && [ -f build/x8-providers.yaml ]; then
            echo ""
            echo "=== X8 providers ==="
            python3 -c "
          import yaml
          with open('build/x8-providers.yaml') as f:
              data = yaml.safe_load(f)
          proxies = data.get('proxies', [])
          print(f'Servers: {len(proxies)}')
          for p in proxies:
              print(f'  - {p[\"name\"]} ({p[\"server\"]}:{p[\"port\"]})')
          assert len(proxies) > 0, 'No proxies found!'
          "
          fi

      - name: ðŸ·ï¸ Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: VPN Proxy Providers (auto-updated)
          body: |
            Auto-generated Clash YAML proxy-provider files from VPN subscriptions.

            **Updated:** ${{ github.event.repository.updated_at || 'now' }}
            **Sirius:** âœ…
            **X8:** ${{ env.x8_skipped == 'true' && 'âš ï¸ Skipped (URL expired)' || 'âœ…' }}

            Used by `proxy-providers` in OpenClash config on routers.
          files: |
            build/sirius-providers.yaml
            build/x8-providers.yaml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Summary
        run: |
          echo "### âœ… VPN Providers Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Sirius:** $(grep -c 'name:' build/sirius-providers.yaml) servers" >> $GITHUB_STEP_SUMMARY
          if [ -f build/x8-providers.yaml ] && [ "$x8_skipped" != "true" ]; then
            echo "- **X8:** $(grep -c 'name:' build/x8-providers.yaml) servers" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **X8:** âš ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          fi
