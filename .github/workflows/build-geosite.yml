name: Build Custom Geosite

# ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ
on:
  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 03:00 UTC
  schedule:
    - cron: '0 3 * * *'
  
  # Ð’Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· GitHub UI
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes'
        required: false
        default: 'false'
  
  # ÐŸÑ€Ð¸ push Ð² main (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-geosite.yml'
      - 'custom-data/**'

env:
  # ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð² geosite.dat
  # 
  # cn - Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° (1 Ð´Ð¾Ð¼ÐµÐ½) Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Mihomo
  # Mihomo Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ "cn" Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ geosite.dat
  # Ð‘ÐµÐ· Ð½ÐµÑ‘ Ñ„Ð°Ð¹Ð» ÑÑ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ invalid Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÑ‚ÑÑ
  # Ð¡Ð¼: https://github.com/MetaCubeX/mihomo/blob/Alpha/component/geodata/utils.go#L55
  #
  GEOSITE_CATEGORIES: >-
    cn
    instagram
    facebook
    twitter
    youtube
    netflix
    soundcloud
    kinopub
    category-ai-!cn
    telegram
    whatsapp

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Ð”Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ releases
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ” Check domain-list-community updates
        id: check_updates
        run: |
          echo "Checking for updates..."
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ commit domain-list-community
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/v2fly/domain-list-community/commits/master | jq -r '.sha')
          echo "Latest commit: $LATEST_COMMIT"
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ GEOSITE Ñ€ÐµÐ»Ð¸Ð· (Ñ‚ÐµÐ³Ð¸ v*.*.*)
          # Ð’Ð°Ð¶Ð½Ð¾: Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ /releases/latest, Ñ‚.Ðº. Ð¾Ð½ Ð²ÐµÑ€Ð½Ñ‘Ñ‚ vpn-config Ñ€ÐµÐ»Ð¸Ð·
          # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ regex v\d+.\d+ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ vpn-config-X
          LAST_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases" | jq -r '[.[] | select(.tag_name | test("^v\\d+\\.\\d+"))][0].tag_name // empty')
          
          if [ -z "$LAST_RELEASE" ]; then
            echo "No previous releases found, building first version"
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=v1.0.0" >> $GITHUB_OUTPUT
          else
            echo "Last release: $LAST_RELEASE"
            
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ commit Ð¸Ð· Ñ‚ÐµÐ³Ð° Ñ€ÐµÐ»Ð¸Ð·Ð° (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: v1.0.0-commit-abc123)
            SAVED_COMMIT=$(echo $LAST_RELEASE | grep -oP '(?<=commit-)[a-f0-9]+' || echo "")
            echo "Saved commit: $SAVED_COMMIT"
            
            if [ "$LATEST_COMMIT" != "$SAVED_COMMIT" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]; then
              echo "Changes detected or force build, proceeding with build"
              echo "should_build=true" >> $GITHUB_OUTPUT
              
              # Ð˜Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
              CURRENT_VERSION=$(echo $LAST_RELEASE | grep -oP 'v\d+\.\d+\.\d+')
              NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. -v OFS=. '{$NF++;print}')
              echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
            else
              echo "No changes detected, skipping build"
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: ðŸ› ï¸ Setup Go
        if: steps.check_updates.outputs.should_build == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: ðŸ“¦ Clone domain-list-community
        if: steps.check_updates.outputs.should_build == 'true'
        run: |
          echo "Cloning domain-list-community..."
          git clone --depth 1 https://github.com/v2fly/domain-list-community.git
          cd domain-list-community
          echo "Repository size:"
          du -sh .
      
      - name: ðŸ”§ Apply custom cn stub
        if: steps.check_updates.outputs.should_build == 'true'
        run: |
          echo "Applying custom cn stub for Mihomo compatibility..."
          
          # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ cn (ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ include:tld-cn + geolocation-cn = 1600+ Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð²)
          # Ð½Ð° Ð½Ð°ÑˆÑƒ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ (1 Ð´Ð¾Ð¼ÐµÐ½)
          cp custom-data/cn domain-list-community/data/cn
          
          echo "âœ“ Custom cn stub applied"
          echo "Content:"
          cat domain-list-community/data/cn
      
      - name: âœ‚ï¸ Extract dependencies
        if: steps.check_updates.outputs.should_build == 'true'
        run: |
          cd domain-list-community
          
          # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ history expansion Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‰Ð¸Ð¼Ð¸ !
          set +H
          
          echo "Finding all dependencies..."
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð½ÑƒÐ¶Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸)
          NEEDED_FILES=$(mktemp)
          
          # ÐÐ°ÑˆÐ¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
          for cat in ${{ env.GEOSITE_CATEGORIES }}; do
            echo "$cat" >> $NEEDED_FILES
          done
          
          # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¾Ð² Ð´Ð»Ñ Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ñ‹Ñ… include)
          for pass in 1 2 3; do
            while IFS= read -r file; do
              if [ -f "data/$file" ]; then
                # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ (# ...) Ð¸ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹ (@ads, @cn Ð¸ Ñ‚.Ð´.) Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°
                grep "^include:" "data/$file" 2>/dev/null | sed 's/include://' | sed 's/ #.*$//' | sed 's/ @.*$//' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' >> $NEEDED_FILES
              fi
            done < $NEEDED_FILES
            sort -u $NEEDED_FILES -o $NEEDED_FILES
          done
          
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹
          sort -u $NEEDED_FILES -o $NEEDED_FILES
          
          echo "ðŸ“¦ Files to copy:"
          cat $NEEDED_FILES
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          mkdir -p data-filtered
          while IFS= read -r file; do
            if [ -f "data/$file" ]; then
              echo "  âœ“ $file"
              cp "data/$file" "data-filtered/"
            else
              echo "  âš ï¸  $file not found"
            fi
          done < $NEEDED_FILES
          
          echo ""
          echo "Total files: $(ls data-filtered/ | wc -l)"
          
          # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ data
          rm -rf data
          mv data-filtered data
      
      - name: ðŸ”¨ Build geosite.dat
        if: steps.check_updates.outputs.should_build == 'true'
        run: |
          cd domain-list-community
          
          echo "Building geosite.dat..."
          go run ./ --outputdir=../build
          
          echo "Build complete!"
          ls -lh ../build/
          
          # domain-list-community ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ Ñ„Ð°Ð¹Ð» dlc.dat, Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð² geosite.dat
          if [ -f ../build/dlc.dat ]; then
            mv ../build/dlc.dat ../build/geosite.dat
            echo "âœ“ Renamed dlc.dat to geosite.dat"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€
          SIZE=$(du -h ../build/geosite.dat | cut -f1)
          echo "Final size: $SIZE"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ Ð½Ðµ Ð¿ÑƒÑÑ‚Ð¾Ð¹
          if [ ! -f ../build/geosite.dat ]; then
            echo "Error: geosite.dat not created"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s ../build/geosite.dat)
          if [ $FILE_SIZE -lt 10000 ]; then
            echo "Error: geosite.dat is too small ($FILE_SIZE bytes)"
            exit 1
          fi
          
          echo "âœ“ Validation passed"
          echo "file_size=$SIZE" >> $GITHUB_ENV
      
      - name: ðŸ“ Generate release notes
        if: steps.check_updates.outputs.should_build == 'true'
        run: |
          cat > release_notes.md << EOF
          # ðŸŽ‰ Custom Geosite Release ${{ steps.check_updates.outputs.version }}
          
          ## ðŸ“¦ Build Info
          
          - **Size:** ${{ env.file_size }}
          - **Categories:** $(echo "${{ env.GEOSITE_CATEGORIES }}" | wc -w) included
          - **Source Commit:** \`${{ steps.check_updates.outputs.latest_commit }}\`
          - **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ“‹ Included Categories
          
          $(echo "${{ env.GEOSITE_CATEGORIES }}" | tr ' ' '\n' | sed 's/^/- /')
          
          ## âš ï¸ Note about "cn" category
          
          The "cn" category is a **minimal stub** (1 placeholder domain) for Mihomo compatibility.
          Mihomo validates geosite.dat by checking if "cn" exists. Without it, the file is deleted.
          This stub does NOT include real Chinese domains to save router RAM.
          
          ## ðŸš€ How to Use
          
          ### OpenClash
          
          1. Download \`geosite.dat\` from this release
          2. Upload to \`/etc/openclash/\` on your router
          3. Restart OpenClash
          
          ### Manual Download
          
          \`\`\`bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.check_updates.outputs.version }}-commit-${{ steps.check_updates.outputs.latest_commit }}/geosite.dat
          \`\`\`
          
          ## ðŸ”„ Auto-Update
          
          OpenClash can auto-update from GitHub releases. Configure in OpenClash settings.
          
          ---
          
          **Built with â¤ï¸ by [GitHub Actions](https://github.com/${{ github.repository }}/actions)**
          EOF
          
          cat release_notes.md
      
      - name: ðŸ·ï¸ Create Release
        if: steps.check_updates.outputs.should_build == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_updates.outputs.version }}-commit-${{ steps.check_updates.outputs.latest_commit }}
          name: Custom Geosite ${{ steps.check_updates.outputs.version }}
          body_path: release_notes.md
          files: |
            build/geosite.dat
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“± Notify Telegram (Success)
        if: steps.check_updates.outputs.should_build == 'true' && success()
        run: |
          curl -X POST "${{ secrets.RAILWAY_WEBHOOK_URL }}/webhook/build-complete" \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ steps.check_updates.outputs.version }}",
              "commit": "${{ steps.check_updates.outputs.latest_commit }}",
              "size": "${{ env.file_size }}",
              "status": "success",
              "url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.check_updates.outputs.version }}-commit-${{ steps.check_updates.outputs.latest_commit }}"
            }'
      
      - name: ðŸ“± Notify Telegram (Failure)
        if: steps.check_updates.outputs.should_build == 'true' && failure()
        run: |
          curl -X POST "${{ secrets.RAILWAY_WEBHOOK_URL }}/webhook/build-complete" \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ steps.check_updates.outputs.version }}",
              "commit": "${{ steps.check_updates.outputs.latest_commit }}",
              "status": "failed",
              "error": "Build failed, check logs"
            }'
      
      - name: âœ… Build Summary
        if: steps.check_updates.outputs.should_build == 'true'
        run: |
          echo "### ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.check_updates.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** ${{ env.file_size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Categories:** $(echo "${{ env.GEOSITE_CATEGORIES }}" | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ steps.check_updates.outputs.latest_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[ðŸ“¦ View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.check_updates.outputs.version }}-commit-${{ steps.check_updates.outputs.latest_commit }})" >> $GITHUB_STEP_SUMMARY
      
      - name: â„¹ï¸ No Build Needed
        if: steps.check_updates.outputs.should_build == 'false'
        run: |
          echo "### â„¹ï¸ No Build Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected in domain-list-community since last release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To force a build, run workflow manually with 'force_build' enabled." >> $GITHUB_STEP_SUMMARY
