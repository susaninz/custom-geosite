name: Update VPN Subscriptions

on:
  schedule:
    - cron: '0 4 * * *'  # 07:00 ÐœÐ¡Ðš
  workflow_dispatch:

env:
  X8_SUB_URL: "https://connect.x8net.world/X8/WDg0ODQ2OCwxNzU3Njk5MDk28Nk0BeXa_x"
  SIRIUS_SUB_URL: "https://s.creati.win/sub/eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJzaXJpdXN2cG5fNzM5ODEzXzEifQ.qR2TNxDnze-wvDHoc9flc2zfJHEhGTGMGXSRB8wXtnk"

jobs:
  build-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Download subscriptions
        id: download
        run: |
          echo "Downloading X8..."
          curl -sL -H "User-Agent: v2rayNG" "${{ env.X8_SUB_URL }}" | base64 -d > /tmp/x8.txt
          X8_COUNT=$(grep -c "^vless://" /tmp/x8.txt || echo 0)
          echo "x8_count=$X8_COUNT" >> $GITHUB_OUTPUT
          
          echo "Downloading Sirius..."
          curl -sL "${{ env.SIRIUS_SUB_URL }}" | base64 -d > /tmp/sirius.txt
          SIRIUS_COUNT=$(grep -c "^vless://" /tmp/sirius.txt || echo 0)
          echo "sirius_count=$SIRIUS_COUNT" >> $GITHUB_OUTPUT
          
          echo "X8: $X8_COUNT servers, Sirius: $SIRIUS_COUNT servers"
      
      - name: ðŸ”¨ Generate config
        run: |
          python3 << 'EOF'
          import urllib.parse, re

          def parse_vless(url, prefix):
              url = url.strip()
              if not url.startswith('vless://') or '#' not in url:
                  return None, None
              name = f"[{prefix}] {urllib.parse.unquote(url.split('#')[1])}"
              m = re.match(r'vless://([^@]+)@([^:]+):(\d+)', url.split('#')[0])
              if not m: return None, None
              params = dict(p.split('=',1) for p in url.split('?')[1].split('#')[0].split('&') if '=' in p) if '?' in url else {}
              return name, f'''- name: "{name}"
            type: vless
            server: {m[2]}
            port: {m[3]}
            uuid: {m[1]}
            network: tcp
            udp: true
            tls: true
            servername: {params.get('sni', m[2])}
            reality-opts:
              public-key: {params.get('pbk', '')}
              short-id: "{params.get('sid', '')}"
            client-fingerprint: {params.get('fp', 'chrome')}
            packet-encoding: xudp'''

          x8 = [parse_vless(l, 'X8') for l in open('/tmp/x8.txt') if l.startswith('vless://')]
          x8 = [(n,y) for n,y in x8 if y]
          sirius = [parse_vless(l, 'Sirius') for l in open('/tmp/sirius.txt') if l.startswith('vless://')]
          sirius = [(n,y) for n,y in sirius if y]
          yt = next((n for n,_ in sirius if 'YouTube' in n or 'youtube' in n.lower()), None)

          with open('/tmp/openclash-config.yaml', 'w') as f:
              f.write(f'''mixed-port: 7893
          socks-port: 7891
          redir-port: 7892
          allow-lan: true
          mode: rule
          log-level: info
          external-controller: 0.0.0.0:9090
          dns:
            enable: true
            fake-ip-range: 198.18.0.1/16
            default-nameserver: [1.1.1.1, 8.8.8.8]
            nameserver: [1.1.1.1, 8.8.8.8]
            enhanced-mode: fake-ip
            listen: 0.0.0.0:7874

          proxies:
          ''')
              for _,y in x8: f.write(y + '\n\n')
              for _,y in sirius: f.write(y + '\n\n')
              
              f.write('proxy-groups:\n- name: "X8 Provider"\n  type: url-test\n  url: http://www.gstatic.com/generate_204\n  interval: 60\n  timeout: 3000\n  proxies:\n')
              for n,_ in x8: f.write(f'  - "{n}"\n')
              f.write('\n- name: "Sirius Provider"\n  type: url-test\n  url: http://www.gstatic.com/generate_204\n  interval: 60\n  timeout: 3000\n  proxies:\n')
              for n,_ in sirius: f.write(f'  - "{n}"\n')
              f.write('''
          - name: "Proxy"
            type: fallback
            url: http://www.gstatic.com/generate_204
            interval: 30
            proxies: ["X8 Provider", "Sirius Provider"]

          - name: "YouTube"
            type: fallback
            url: http://www.gstatic.com/generate_204
            interval: 60
            proxies:
          ''')
              if yt: f.write(f'  - "{yt}"\n')
              f.write('  - "X8 Provider"\n  - "Sirius Provider"\n')
              f.write('''
          rules:
          - IP-CIDR,192.168.0.0/16,DIRECT
          - IP-CIDR,10.0.0.0/8,DIRECT
          - DOMAIN-SUFFIX,youtube.com,YouTube
          - DOMAIN-SUFFIX,youtu.be,YouTube
          - DOMAIN-SUFFIX,googlevideo.com,YouTube
          - DOMAIN-SUFFIX,ytimg.com,YouTube
          - DOMAIN-SUFFIX,instagram.com,Proxy
          - DOMAIN-SUFFIX,cdninstagram.com,Proxy
          - DOMAIN-SUFFIX,facebook.com,Proxy
          - DOMAIN-SUFFIX,twitter.com,Proxy
          - DOMAIN-SUFFIX,x.com,Proxy
          - DOMAIN-SUFFIX,netflix.com,Proxy
          - DOMAIN-SUFFIX,openai.com,Proxy
          - DOMAIN-SUFFIX,chatgpt.com,Proxy
          - DOMAIN-SUFFIX,claude.ai,Proxy
          - DOMAIN-SUFFIX,anthropic.com,Proxy
          - DOMAIN-SUFFIX,cursor.sh,Proxy
          - DOMAIN-SUFFIX,kinopub.me,Proxy
          - MATCH,DIRECT
          ''')
          print(f"Config: X8={len(x8)}, Sirius={len(sirius)}, YouTube={yt}")
          EOF
      
      - name: ðŸ“¦ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: vpn-config-${{ github.run_number }}
          name: VPN Config ${{ github.run_number }}
          body: |
            ðŸ”„ Auto-generated VPN config
            - X8: ${{ steps.download.outputs.x8_count }} servers
            - Sirius: ${{ steps.download.outputs.sirius_count }} servers
          files: /tmp/openclash-config.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ·ï¸ Update latest tag
        run: |
          cp /tmp/openclash-config.yaml openclash-config.yaml
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add openclash-config.yaml
          git commit -m "Update VPN config" || true
          git tag -f vpn-latest
          git push -f origin vpn-latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
